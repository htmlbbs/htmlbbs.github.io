<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Groß- und Kleinschreibung – A2 Kapitel 6</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#152038;
      --muted:#5b6475;
      --accent:#2962ff;
      --ok:#2e7d32;
      --warn:#ef6c00;
      --bad:#c62828;
      --chip:#eef2ff;
      --drop:#e8f5e9;
      --drop2:#fff3e0;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --border:#e3e6ef;
      --cap:#0d47a1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink); background:var(--bg);
    }
    header{
      position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#ffffff 0%, #fafbff 100%);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 20px;}
    h1{font-size:1.4rem; margin:0 0 6px 0;}
    .scorebar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted);
      font-size:.95rem;
    }
    .scorebar .pill{
      background:var(--card); border:1px solid var(--border); border-radius:100px; padding:6px 10px;
    }
    /* Ampel-Färbung (IHK-Schlüssel in 6 Stufen) */
    .pill.neutral{ background:var(--card); color:inherit; border-color:var(--border) }
    .pill.danger{ background:#fdecea; color:#b71c1c; border-color:#f5c6cb }
  /* <50% soll ein Rotton sein */
  .pill.bad{ background:#ffebee; color:#c62828; border-color:#ffcdd2 }
    .pill.mid{ background:#fff9c4; color:#7a6e00; border-color:#fff59d }
    .pill.ok{ background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9 }
    .pill.good{ background:#d0f0d7; color:#1b5e20; border-color:#b2dfbd }
    .pill.excellent{ background:#c8e6c9; color:#1b5e20; border-color:#a5d6a7 }
    main .section{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px;
      margin:16px auto; box-shadow:var(--shadow);
    }
    h2{font-size:1.2rem; margin:0 0 8px 0;}
    .desc{color:var(--muted); margin-bottom:12px;}
    .area{display:grid; gap:14px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--chip); border:1px solid #d6dcff; color:#1b2a6f;
      padding:8px 10px; border-radius:999px; cursor:grab; user-select:none;
      transition:.15s transform ease;
    }
    .chip:active{transform:scale(.97); cursor:grabbing;}
    .bins{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .bin{
      min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fafbff;
    }
    .bin-title{font-weight:600; margin-bottom:6px;}
    .bin.gr{background:var(--drop)}
    .bin.kl{background:var(--drop2)}
    .pool{min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fff;}
    .btnbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px;}
    button{
      appearance:none; border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px;
      cursor:pointer; font-weight:600; box-shadow:0 2px 10px rgba(41,98,255,.25);
    }
    button.secondary{background:#e8ebf8; color:#1b2a6f; box-shadow:none}
    button.ghost{background:transparent; color:var(--muted); box-shadow:none}
    button:disabled{opacity:.5; cursor:not-allowed}
    .hint{color:var(--muted); font-size:1.0rem}
    .smallcaps{font-variant:small-caps; letter-spacing:.03em; color:var(--cap); border-bottom:1px dotted #90caf9; cursor:pointer;}
  .smallcaps.pending{ background:#ffe0b2; color:#8a4b00; padding:0 2px; border-radius:4px }
    .popup{
      position:absolute; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);
      padding:6px; display:none; z-index:10;
    }
    .popup button{padding:6px 10px; margin:2px; box-shadow:none}
    .sentence{line-height:1.7}
    .card{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff}
    .locked{opacity:.65; pointer-events:none}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1b2a6f; font-size:.85rem; margin-left:6px}
    .result{font-weight:700}
    .texttokens{line-height:1.9}
    .tok{padding:2px 2px; border-radius:4px; cursor:pointer}
    .tok.cap{background:#e3f2fd; border:1px solid #bbdefb}
    .tok.correct{box-shadow:inset 0 0 0 2px #a5d6a7}
    /* .tok.wrong removed for Aufgabe 3 */
    .preview{border:1px dashed var(--border); border-radius:10px; padding:10px; background:#fcfcff}
  /* Ursprungstext größer und nicht kopierbar */
  #story4src{ font-size:1.2rem; user-select:none }
    .mark-cap{background:#fff3cd}
    .mark-typo{background:#ffebee}
  textarea{width:100%; min-height:140px; resize:vertical; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:1.4rem;}
    .counter{color:var(--muted); font-size:.92rem}
    .badge{display:inline-block; padding:2px 8px; border-radius:12px; background:#f0f4ff; color:#1b2a6f; font-size:.82rem; margin-left:6px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    /* Sätze mit Fehlern visuell markieren */
    .sentence.error{border-color:#ef9a9a; background:#fff7f7}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Übungen: Groß- und Kleinschreibung</h1>
  </div>
</header>

<main class="wrap">

  <section class="section" id="task1">
    <h2>Aufgabe 1 – Wörter zu „groß“ oder „klein“ ziehen <span class="badge">20 Punkte</span></h2>
    <div class="desc">
      Aufgabe: „Wie wird dieses Wort im Satz (nicht am Satzanfang) geschrieben?“ Ziehe jedes Wort in das richtige Feld.
    </div>
    <div class="area">
      <div class="row">
        <div class="card" style="flex:1">
          <div class="bin-title">Nicht sortiert</div>
          <div id="pool1" class="pool" data-accept="any"></div>
        </div>
      </div>
      <div class="bins">
        <div class="card">
          <div class="bin-title">groß (Nomen, Eigennamen)</div>
          <div id="binUpper" class="bin gr" data-accept="upper"></div>
        </div>
        <div class="card">
          <div class="bin-title">klein (Verben, Adjektive, Präpositionen, Artikel)</div>
          <div id="binLower" class="bin kl" data-accept="lower"></div>
        </div>
      </div>
      <div class="btnbar">
        <button id="check1" disabled>Prüfen – Versuch 1</button>
        <button id="retry1" class="secondary" disabled>Zweiter Versuch</button>
        <span class="hint">Max. 20 Punkte. Im 2. Versuch halbe Punkte je nachträglich richtigem Wort.</span>
      </div>
      <div class="result" id="res1"></div>
    </div>
  </section>

  <section class="section" id="task2">
    <h2>Aufgabe 2 – Wähle „groß/klein“ in Sätzen <span class="badge">20 Punkte</span></h2>
    <div class="desc">
      In jedem Satz sind zwei Wörter markiert. Klicke sie an und wähle, ob sie groß oder klein geschrieben werden.
    </div>
    <div id="sentences" class="area"></div>
    <div class="btnbar">
      <button id="check2" disabled>Prüfen – Versuch 1</button>
      <button id="retry2" class="secondary" disabled>Zweiter Versuch</button>
      <span class="hint">Max. 20 Punkte. Im 2. Versuch halbe Punktzahl.</span>
    </div>
    <div class="popup" id="popup2">
      <button data-choice="upper">groß</button>
      <button data-choice="lower">klein</button>
    </div>
    <div class="result" id="res2"></div>
  </section>

  <section class="section" id="task3">
    <h2>Aufgabe 3 – Klicke die Wörter groß <span class="badge">30 Punkte</span></h2>
    <div class="desc">
      Alle Wörter sind klein geschrieben. Klicke Wörter, die groß geschrieben werden müssen (Satzanfänge, Nomen, Namen, Länder/ Städte).<br><br>
    <div id="story3" class="card texttokens"></div>
    <div class="btnbar">
      <button id="check3">Prüfen – Versuch 1</button>
      <button id="retry3" class="secondary" disabled>Zweiter Versuch</button>
    </div>
    <div class="result" id="res3"></div>
  </section>

  <section class="section" id="task4">
    <h2>Aufgabe 4 – Richtig abschreiben <span class="badge">30 Punkte</span></h2>
    <div class="desc">
  Schreibe die klein geschriebene Geschichte in das Textfeld ab – mit korrekter Groß-/Kleinschreibung.<br>
    <b>Bitte vergesse beim Abschreiben keine Wörter. Dann funktioniert die Korrektur nicht!</b><br>
    (Schreibfehler werden markiert, zählen aber nicht zur Punktzahl.)
    </div>
    <div id="story4src" class="preview mono"></div>
    <div class="row">
      <textarea id="story4txt" spellcheck="false" placeholder="Hier korrekt abschreiben …"></textarea>
    </div>
    <div class="btnbar">
      <button id="check4" disabled>Prüfen – Versuch 1</button>
      <button id="retry4" class="secondary" disabled>Zweiter Versuch</button>
      <span class="counter" id="c4"></span>
    </div>
    <div class="preview" id="story4feedback"></div>
    <div class="result" id="res4"></div>
  </section>

  <section class="section" id="task5">
    <h2>Aufgabe 5 – Diktat <span class="badge">30 Punkte</span></h2>
    <div class="desc">
      Höre dir jeden Satz an und schreibe ihn mit korrekter Groß- und Kleinschreibung in das Eingabefeld.
      Du kannst jeden Satz beliebig oft anhören.<br>
      <b>Bewertung:</b> Pro Satz max. 5 Punkte (10 Fehler = 0 Punkte, 0 Fehler = 5 Punkte)
    </div>
    <div id="diktat-sentences" class="area"></div>
    <div class="btnbar">
      <button id="check5">Prüfen – Versuch 1</button>
      <button id="retry5" class="secondary" disabled>Zweiter Versuch</button>
      <span class="hint">Max. 30 Punkte. Im 2. Versuch volle Punktzahl möglich.</span>
    </div>
    <div class="result" id="res5"></div>
  </section>

</main>

<!-- Gesamtauswertung unten -->
<section class="wrap section" id="summary">
  <h2>Punkte</h2>
  <div class="scorebar" id="scorebarBottom">
    <div class="pill" id="totalPill">Gesamt: <span id="totalScore">0</span> / 130</div>
    <div class="pill" id="pill1">A1: <span id="s1">0</span>/20</div>
    <div class="pill" id="pill2">A2: <span id="s2">0</span>/20</div>
    <div class="pill" id="pill3">A3: <span id="s3">0</span>/30</div>
    <div class="pill" id="pill4">A4: <span id="s4">0</span>/30</div>
    <div class="pill" id="pill5">A5: <span id="s5">0</span>/30</div>
  </div>
  <div id="completeInfo" class="result ok" style="display:none; margin-top:8px">Alle Aufgaben abgeschlossen: Jede Aufgabe ist entweder vollständig richtig oder nach zwei Versuchen beendet.</div>
  <div id="reloadTip" class="desc" style="display:none">Tipp: Du kannst die Seite neu laden, um andere zufällige Inhalte zu erhalten.</div>
  <br/>
</section>

<footer class="wrap" style="color:var(--muted); padding-bottom:40px">
  
</footer>

<script>
(function(){
  const rnd = (n)=>Math.floor(Math.random()*n);
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const pickN = (arr, n)=>shuffle(arr.slice()).slice(0,n);
  const deLower = s => s.toLocaleLowerCase('de-DE');
  const deUpper = s => s.toLocaleUpperCase('de-DE');
  const capFirst = s => s.replace(/^([a-zäöüß])/i, (m)=>m.toLocaleUpperCase('de-DE'));
  const isWord = (t)=>/^[A-Za-zÄÖÜäöüß\-]+$/.test(t);
  const stripPunct = (t)=>t.replace(/^[^\p{L}]+|[^\p{L}]+$/gu,'');
  const tokenize = (text)=>{
    const parts = [];
    let m, re = /([A-Za-zÄÖÜäöüß\-]+|[0-9]+|[^\sA-Za-zÄÖÜäöüß0-9\-]+)/g;
    let last = 0;
    while((m=re.exec(text))!==null){
      const idx = m.index;
      if(idx>last){
        const gap = text.slice(last, idx);
      }
      parts.push(m[0]);
      last = idx + m[0].length;
    }
    return parts;
  };

  // =========================
  // Inhalte aus Kapitel 6: Wohnung, Umzug, Nachbarn
  // =========================
  const NOUNS = [
    'die Wohnung','das Haus','die Miete','die Monatsmiete','die Nebenkosten','die Kaution','der Vermieter','die Vermieterin',
    'der Nachmieter','die Nachmieterin','das Haustier','die Einbauküche','der Herd','der Kühlschrank','die Lampe',
    'die Tapete','der Hammer','der Nagel','die Leiter','der Umzug','die Renovierung','der Vorort','die Innenstadt',
    'die Lage','der Balkon','die Terrasse','der Garten','das Hochhaus','das Einfamilienhaus','der Neubau',
    'die Großstadt','die Kleinstadt','das Dorf','die Ruhe','die Verkehrsmittel','der Bus','die U-Bahn','die Straßenbahn',
    'die S-Bahn','der Bahnhof','die Haltestelle','die Verbindung','der Anschluss','die Linie','der Fahrplan',
    'das Zentrum','die Gegend','die Nachbarn','der Nachbar','die Nachbarin','die Meinung','der Streit',
    'die Entschuldigung','das Verständnis','die Freundschaft','der Konflikt','das Problem','die Lösung',
    'der Verein','die Gemeinschaft','die Hilfe','der Besuch','die Party','das Fest','die Feier',
    'der Lärm','die Musik','die Beschwerde','das Gespräch','die Vereinbarung','der Kompromiss',
    'das Zimmer','das Schlafzimmer','das Wohnzimmer','die Küche','das Bad','das WC','der Flur',
    'der Keller','der Dachboden','die Garage','der Parkplatz','der Aufzug','die Treppe',
    'das Fenster','die Tür','die Wand','der Boden','die Decke','der Schlüssel','die Klingel',
    'der Briefkasten','der Müll','die Mülltonne','die Waschmaschine','der Trockner'
  ];
  const VERBS = [
    'wohnen','mieten','vermieten','umziehen','einziehen','ausziehen','renovieren','streichen','tapezieren',
    'aufhängen','anschließen','anmelden','suchen','finden','besichtigen','unterschreiben','zahlen','kosten',
    'liegen','stehen','hängen','stellen','legen','klingeln','öffnen','schließen','abschließen',
    'aufräumen','putzen','sauber machen','waschen','trocknen','bügeln','aufheben','wegwerfen',
    'sich streiten','sich entschuldigen','sich verlieben','sich trennen','sich kennenlernen','sich freuen',
    'sich ärgern','sich beschweren','helfen','stören','feiern','einladen','besuchen','treffen',
    'sprechen','reden','diskutieren','erklären','verstehen','hören','zuhören','lärmen'
  ];
  const ADJS = [
    'groß','klein','hell','dunkel','ruhig','laut','schön','hässlich','teuer','billig',
    'günstig','modern','alt','neu','zentral','verkehrsgünstig','sympathisch','unsympathisch',
    'freundlich','unfreundlich','höflich','unhöflich','stark','schwach','leer','voll',
    'sauber','schmutzig','ordentlich','unordentlich','möbliert','unmöbliert','renoviert'
  ];
  const PREPS = [
    'in','auf','unter','über','neben','vor','hinter','zwischen','an','bei',
    'zu','nach','von','aus','mit','ohne','für','gegen','durch','um',
    'außerhalb','innerhalb','wegen','trotz','statt','bis','seit','während'
  ];
  const ARTS = [
    'der','die','das','ein','eine','einen','einem','einer','den','dem',
    'des','mein','meine','dein','deine','sein','seine','ihr','ihre','unser','euer','kein','keine'
  ];

  // Aufgabe 1: Wort-Datenbank erstellen
  const wordsDB = (()=> {
    const o = [];
    NOUNS.forEach(w=>o.push({word:w,pos:'Nomen', expect:'upper', base: stripPunct(w.replace(/^(der|die|das|den|dem|des|ein|eine|einen |einem |einer)\s+/,'')).toLowerCase()}));
    VERBS.forEach(w=>o.push({word:w,pos:'Verb', expect:'lower', base: w.toLowerCase()}));
    PREPS.forEach(w=>o.push({word:w,pos:'Präposition', expect:'lower', base: w.toLowerCase()}));
    ADJS.forEach(w=>o.push({word:w,pos:'Adjektiv', expect:'lower', base: w.toLowerCase()}));
    ARTS.forEach(w=>o.push({word:w,pos:'Artikel', expect:'lower', base: w.toLowerCase()}));
    // Ambiguitäten filtern
    const seen = {};
    o.forEach(it=>{
      seen[it.base] = seen[it.base] || new Set();
      seen[it.base].add(it.expect);
    });
    const filtered = o.filter(it=> seen[it.base].size === 1);
    return filtered;
  })();

  // Aufgabe 2: Sätze zum Thema Wohnung/Umzug/Nachbarn
  function buildSentences50(){
    return [
      { tokens:['Die','Wohnung','liegt','zentral','in','der','Innenstadt.'], targets:[{i:1,should:'upper'},{i:6,should:'upper'}] },
      { tokens:['Im','Hochhaus','wohnen','viele','Nachbarn','aus','verschiedenen','Ländern.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Die','Monatsmiete','kostet','achthundert','Euro','plus','Nebenkosten.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
      { tokens:['Der','Vermieter','verlangt','eine','Kaution','von','drei','Monatsmieten.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
      { tokens:['In','der','Küche','steht','ein','neuer','Herd','und','Kühlschrank.'], targets:[{i:3,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Wir','müssen','die','Wohnung','bis','Ende','des','Monats','renovieren.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Am','Samstag','helfen','mir','meine','Freunde','beim','Umzug.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Lage','ist','verkehrsgünstig','mit','guten','öffentlichen','Verkehrsmitteln.'], targets:[{i:3,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Der','Nachbar','klingelt','und','beschwert','sich','über','den','Lärm.'], targets:[{i:2,should:'lower'},{i:8,should:'upper'}] },
      { tokens:['Im','Vorort','gibt','es','viel','Ruhe','und','einen','schönen','Garten.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Einbauküche','bleibt','in','der','Wohnung','für','den','Nachmieter.'], targets:[{i:2,should:'lower'},{i:8,should:'upper'}] },
      { tokens:['Wir','streichen','die','Wände','im','Wohnzimmer','hellblau.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','U-Bahn','fährt','alle','zehn','Minuten','zum','Zentrum.'], targets:[{i:2,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['In','einem','Einfamilienhaus','hat','man','mehr','Platz','als','in','einer','Wohnung.'], targets:[{i:3,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Der','Balkon','ist','klein','aber','hat','viel','Sonne.'], targets:[{i:2,should:'lower'},{i:6,should:'lower'}] },
      { tokens:['Die','Nachbarn','feiern','eine','Party','und','laden','uns','ein.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Heute','müssen','wir','den','Mietvertrag','beim','Vermieter','unterschreiben.'], targets:[{i:1,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Die','Nebenkosten','für','Heizung','und','Strom','sind','hoch.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Im','Keller','stehen','alte','Möbel','und','Kartons.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Der','Aufzug','ist','kaputt','und','man','muss','die','Treppe','nehmen.'], targets:[{i:2,should:'lower'},{i:8,should:'upper'}] },
      { tokens:['Die','Vermieterin','zeigt','uns','die','Wohnung','am','Nachmittag.'], targets:[{i:2,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Wir','suchen','eine','möblierte','Wohnung','in','ruhiger','Lage.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','S-Bahn','hält','direkt','vor','dem','Haus.'], targets:[{i:2,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['In','der','Großstadt','sind','die','Mieten','sehr','teuer.'], targets:[{i:3,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Der','Garten','gehört','allen','Mietern','im','Haus.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Wir','hängen','eine','Lampe','an','die','Decke','im','Flur.'], targets:[{i:1,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Die','Verbindung','mit','öffentlichen','Verkehrsmitteln','ist','gut.'], targets:[{i:3,should:'lower'},{i:5,should:'lower'}] },
      { tokens:['Im','Dorf','kennen','sich','alle','Nachbarn','persönlich.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Der','Streit','mit','den','Nachbarn','dauert','schon','lange.'], targets:[{i:5,should:'lower'},{i:7,should:'lower'}] },
      { tokens:['Die','Renovierung','kostet','mehr','als','geplant.'], targets:[{i:2,should:'lower'},{i:4,should:'lower'}] },
      { tokens:['Wir','schließen','den','Herd','in','der','Küche','an.'], targets:[{i:1,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Die','Kleinstadt','hat','gute','Schulen','und','Geschäfte.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Der','Hausmeister','repariert','die','Waschmaschine','im','Keller.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Die','Terrasse','ist','groß','und','hat','einen','schönen','Ausblick.'], targets:[{i:2,should:'lower'},{i:5,should:'lower'}] },
      { tokens:['Wir','stellen','die','Möbel','ins','Wohnzimmer','und','räumen','auf.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Haltestelle','liegt','nur','fünf','Minuten','vom','Haus','entfernt.'], targets:[{i:2,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Im','Neubau','gibt','es','moderne','Wohnungen','mit','Balkon.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Der','Schlüssel','für','die','Wohnung','ist','beim','Vermieter.'], targets:[{i:2,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','Nachbarin','ist','sehr','freundlich','und','hilfsbereit.'], targets:[{i:2,should:'lower'},{i:4,should:'lower'}] },
      { tokens:['Wir','tapezieren','das','Schlafzimmer','und','streichen','die','Decke','weiß.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','Miete','muss','am','Ersten','des','Monats','bezahlt','werden.'], targets:[{i:2,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Im','Altbau','sind','die','Zimmer','groß','und','hell.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Der','Fahrplan','hängt','an','der','Haltestelle','aus.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Klingel','funktioniert','nicht','mehr','und','muss','repariert','werden.'], targets:[{i:2,should:'lower'},{i:3,should:'lower'}] },
      { tokens:['Wir','legen','Teppich','im','Wohnzimmer','und','hängen','Bilder','auf.'], targets:[{i:1,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Die','Garage','hat','Platz','für','zwei','Autos.'], targets:[{i:2,should:'lower'},{i:3,should:'upper'}] },
      { tokens:['Der','Konflikt','entsteht','wegen','lauter','Musik','am','Abend.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Gemeinschaft','im','Haus','organisiert','ein','Sommerfest.'], targets:[{i:2,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Wir','entschuldigen','uns','bei','den','Nachbarn','für','den','Lärm.'], targets:[{i:1,should:'lower'},{i:8,should:'upper'}] },
      { tokens:['Die','Wohnung','ist','unmöbliert','und','wir','brauchen','neue','Möbel.'], targets:[{i:2,should:'lower'},{i:8,should:'upper'}] },
      { tokens:['Der','Parkplatz','kostet','extra','fünfzig','Euro','im','Monat.'], targets:[{i:2,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','Linie','sechs','fährt','direkt','zur','Innenstadt.'], targets:[{i:3,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Im','Bad','renovieren','wir','die','Fliesen','und','das','Waschbecken.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Freundschaft','mit','den','Nachbarn','ist','sehr','wichtig.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Wir','finden','einen','Kompromiss','und','lösen','das','Problem.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Der','Briefkasten','ist','voll','und','muss','geleert','werden.'], targets:[{i:2,should:'lower'},{i:3,should:'lower'}] },
      { tokens:['Die','Mülltonne','steht','im','Hof','hinter','dem','Haus.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Im','Verein','treffen','sich','die','Nachbarn','jeden','Mittwoch.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Beschwerde','kommt','vom','Nachbarn','wegen','der','Party.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Wir','vereinbaren','einen','Termin','zur','Wohnungsbesichtigung.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Die','Wand','ist','feucht','und','muss','getrocknet','werden.'], targets:[{i:2,should:'lower'},{i:3,should:'lower'}] },
      { tokens:['Der','Boden','im','Flur','quietscht','beim','Gehen.'], targets:[{i:2,should:'lower'},{i:3,should:'upper'}] },
      { tokens:['Die','Hilfe','der','Nachbarn','beim','Umzug','ist','unbezahlbar.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
      { tokens:['Im','Zentrum','sind','die','Wohnungen','klein','und','teuer.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Wir','besichtigen','morgen','drei','Wohnungen','in','der','Stadt.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','Vereinbarung','mit','dem','Vermieter','gilt','für','zwei','Jahre.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Der','Dachboden','wird','als','Lagerraum','genutzt.'], targets:[{i:2,should:'lower'},{i:4,should:'upper'}] },
      { tokens:['Die','Gegend','ist','ruhig','mit','vielen','Grünflächen.'], targets:[{i:2,should:'lower'},{i:6,should:'upper'}] },
      { tokens:['Wir','treffen','uns','mit','den','Nachbarn','zum','Grillen.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
      { tokens:['Die','Lösung','des','Problems','kommt','vom','Hausmeister.'], targets:[{i:2,should:'lower'},{i:3,should:'upper'}] }
    ];
  }
  const sentencesDB = buildSentences50();

  // Aufgabe 3/4: Geschichten zum Thema Wohnung/Umzug/Nachbarn
  function genStories(){
    return [
      { correct: 'Familie Müller sucht eine neue Wohnung in der Innenstadt. Die Monatsmiete darf nicht mehr als tausend Euro kosten. Am Samstag besichtigen sie drei Wohnungen.' },
      { correct: 'Der Vermieter zeigt uns die Wohnung im dritten Stock. Sie hat zwei Zimmer, eine Küche und ein Bad. Die Lage ist zentral mit guter Verkehrsanbindung.' },
      { correct: 'Wir ziehen nächste Woche um. Meine Freunde helfen beim Tragen der Möbel. Am Abend feiern wir eine kleine Party in der neuen Wohnung.' },
      { correct: 'Die Nachbarn im Hochhaus sind sehr freundlich. Frau Schmidt von nebenan bringt uns Kuchen. Wir laden sie zum Kaffee ein.' },
      { correct: 'Im Vorort gibt es viel Ruhe und Grünflächen. Die öffentlichen Verkehrsmittel fahren alle zwanzig Minuten. Einkaufen kann man im Zentrum.' },
      { correct: 'Die Renovierung der Wohnung dauert zwei Wochen. Wir streichen die Wände weiß und tapezieren das Schlafzimmer. Die Einbauküche bleibt drin.' },
      { correct: 'Der Nachbar beschwert sich über laute Musik am Abend. Wir entschuldigen uns und versprechen leiser zu sein. Danach verstehen wir uns wieder gut.' },
      { correct: 'Die Kaution beträgt drei Monatsmieten. Die Nebenkosten für Heizung und Wasser kommen extra dazu. Der Mietvertrag gilt für zwei Jahre.' },
      { correct: 'Im Neubau gibt es moderne Wohnungen mit Balkon. Der Aufzug fährt bis in den fünften Stock. Im Keller hat jeder Mieter einen Lagerraum.' },
      { correct: 'Wir hängen Lampen auf und stellen die Möbel ins Wohnzimmer. Die Küche wird von einem Handwerker angeschlossen. Morgen können wir einziehen.' },
      { correct: 'Die U-Bahn hält direkt vor dem Haus. Die Verbindung zum Hauptbahnhof dauert nur zehn Minuten. Das ist sehr verkehrsgünstig für die Arbeit.' },
      { correct: 'In der Kleinstadt sind die Mieten günstiger als in der Großstadt. Man kennt die Nachbarn persönlich. Es gibt gute Schulen und Geschäfte.' },
      { correct: 'Der Umzug ist anstrengend aber die neue Wohnung ist schön hell. Der Garten gehört allen Mietern. Wir freuen uns auf den Sommer.' },
      { correct: 'Die Vermieterin verlangt eine Schufa-Auskunft und drei Gehaltsnachweise. Wir unterschreiben den Vertrag im Büro. Ab nächstem Monat zahlen wir die Miete.' },
      { correct: 'Im Einfamilienhaus hat man mehr Platz für die Kinder. Der Garten ist groß und die Garage bietet Platz für zwei Autos. Die Ruhe ist herrlich.' },
      { correct: 'Die Nachbarn organisieren ein Sommerfest im Hof. Jeder bringt etwas zu essen mit. Die Kinder spielen zusammen und die Erwachsenen unterhalten sich.' },
      { correct: 'Wir suchen eine möblierte Wohnung für sechs Monate. Die Lage sollte zentral sein mit guten öffentlichen Verkehrsmitteln. Der Preis darf nicht zu hoch sein.' },
      { correct: 'Der Hausmeister repariert die Waschmaschine im Keller. Die Klingel an der Haustür funktioniert wieder. Morgen kommt er wegen des tropfenden Wasserhahns.' },
      { correct: 'Die Wohnung liegt außerhalb des Zentrums aber die S-Bahn fährt alle zehn Minuten. In der Gegend gibt es Parks und Spielplätze. Die Miete ist bezahlbar.' },
      { correct: 'Wir streiten uns mit den Nachbarn wegen des Lärms. Nach einem Gespräch finden wir einen Kompromiss. Ab jetzt machen wir nach zweiundzwanzig Uhr leise.' },
      { correct: 'Die Terrasse ist groß und sonnig. Wir stellen Möbel raus und pflanzen Blumen. Im Sommer können wir dort grillen und entspannen.' },
      { correct: 'Im Altbau sind die Zimmer hoch und geräumig. Die Wände sind dick und halten Lärm ab. Die Miete ist höher als im Neubau.' },
      { correct: 'Der Mietvertrag läuft aus und wir müssen einen Nachmieter finden. Wir inserieren online und zeigen die Wohnung Interessenten. Nach zwei Wochen haben wir jemanden.' },
      { correct: 'Die Nachbarin hilft uns beim Einzug. Sie kennt die Gegend gut und gibt Tipps für Einkaufsmöglichkeiten. Wir laden sie zum Dank zum Essen ein.' },
      { correct: 'Im Dorf ist alles ruhiger als in der Stadt. Man hat mehr Kontakt zu den Nachbarn. Die Verbindung mit öffentlichen Verkehrsmitteln ist aber schlechter.' },
      { correct: 'Wir renovieren das Bad selbst. Die Fliesen werden neu verlegt und die Wände gestrichen. Ein Klempner hilft beim Anschließen der Dusche.' },
      { correct: 'Die Monatsmiete steigt nächstes Jahr um fünfzig Euro. Der Vermieter begründet das mit höheren Nebenkosten. Wir überlegen uns umzuziehen.' },
      { correct: 'Der Balkon hat viel Sonne am Nachmittag. Wir stellen Pflanzen auf und hängen eine Markise. Jetzt können wir dort frühstücken.' },
      { correct: 'Die Freundschaft mit den Nachbarn ist wichtig. Wir helfen uns gegenseitig und feiern zusammen Feste. Das macht das Wohnen angenehmer.' },
      { correct: 'Im Hochhaus wohnen Menschen aus vielen Ländern. Die Gemeinschaft ist international und bunt. Manchmal gibt es kulturelle Feste im Gemeinschaftsraum.' },
      { correct: 'Wir besichtigen eine Wohnung mit Einbauküche. Der Herd und der Kühlschrank sind neu. Die Vermieterin erklärt alles genau und gibt uns Bedenkzeit.' }
    ];
  }
  const storiesDB = genStories();

  // Buttons nach 2. Versuch hart deaktivieren (Listener entfernen)
  function hardDisableButton(selector){
    const btn = document.querySelector(selector);
    if(!btn) return;
    const clone = btn.cloneNode(true);
    clone.disabled = true;
    btn.replaceWith(clone);
  }

  // Score state
  const state = {
    scores:[0,0,0,0,0],
    attempts:[0,0,0,0,0]
  };
  const updateScoreBar = ()=>{
    for(let i=0;i<5;i++){
      document.getElementById('s'+(i+1)).textContent = String(Math.round(state.scores[i]));
    }
    const total = state.scores.reduce((a,b)=>a+b,0);
    document.getElementById('totalScore').textContent = String(Math.round(total));
    const allDone = state.attempts.every((att, idx)=>{
      const max = [20,20,30,30,30][idx];
      return att>=2 || Math.round(state.scores[idx]*10)/10 >= max - 1e-9;
    });
    document.getElementById('completeInfo').style.display = allDone ? 'block' : 'none';
    const tip = document.getElementById('reloadTip');
    if(tip) tip.style.display = allDone ? 'block' : 'none';

    const thresholds = (pct)=>{
      if(pct < 30) return 'danger';
      if(pct < 50) return 'bad';
      if(pct < 67) return 'mid';
      if(pct < 80) return 'ok';
      if(pct < 90) return 'good';
      return 'excellent';
    };
    const maxPer = [20,20,30,30,30];
    for(let i=0;i<5;i++){
      const pill = document.getElementById('pill'+(i+1));
      if(!pill) continue;
      pill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
      if(state.attempts[i]===0){
        pill.classList.add('neutral');
      } else {
        const pct = Math.max(0, Math.min(100, (state.scores[i]/maxPer[i])*100));
        pill.classList.add(thresholds(pct));
      }
    }
    const totalPill = document.getElementById('totalPill');
    if(totalPill){
      totalPill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
      if(!allDone){
        totalPill.classList.add('neutral');
      } else {
        const pct = Math.max(0, Math.min(100, (total/130)*100));
        totalPill.classList.add(thresholds(pct));
      }
    }
  };

  // Aufgabe 5 entfernt

  const $ = sel=>document.querySelector(sel);
  const $$ = sel=>Array.from(document.querySelectorAll(sel));

  // Zwei-Versuch-Punkte
  function computeTwoAttemptPoints(totalItems, correctFirst, correctSecondOnly, maxPoints=20){
    const frac = (correctFirst + 0.5*correctSecondOnly) / Math.max(1,totalItems);
    return Math.max(0, Math.min(maxPoints, frac*maxPoints));
  }

  // Aufgabe 1
  let a1 = { items:[], firstCorrect:new Set() };
  function updateTask1CheckEnabled(){
    const remaining = $('#pool1').querySelectorAll('.chip').length;
    // Nach dem ersten Versuch bleibt der Prüfen-Button (1) dauerhaft inaktiv
    const firstAttemptAvailable = state.attempts[0] === 0;
    $('#check1').disabled = !firstAttemptAvailable || remaining>0;
  }
  function initTask1(){
    a1 = { items: pickN(wordsDB,20).map((it,idx)=>({id:'w'+idx, ...it})), firstCorrect:new Set() };
    const pool = $('#pool1'); pool.innerHTML='';
    $('#binUpper').innerHTML=''; $('#binLower').innerHTML='';
    a1.items.forEach(it=>{
      const chip = document.createElement('div');
      chip.className='chip'; chip.draggable=true; chip.id=it.id;
      const base = it.word.replace(/^der |^die |^das |^den |^dem |^des |^ein |^eine |^einen |^einem |^einer /,'');
      chip.textContent = deLower(base);
      chip.dataset.expect = it.expect;
      chip.title = `${it.pos}`;
      chip.addEventListener('dragstart', ev=>{
        ev.dataTransfer.setData('text/plain', it.id);
      });
      pool.appendChild(chip);
    });
    [$('#pool1'), $('#binUpper'), $('#binLower')].forEach(bin=>{
      bin.addEventListener('dragover', ev=>ev.preventDefault());
      bin.addEventListener('drop', ev=>{
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        const el = document.getElementById(id);
        if(!el) return;
        bin.appendChild(el);
        updateTask1CheckEnabled();
      });
    });
    $('#res1').textContent='';
    $('#check1').disabled=true;
    $('#retry1').disabled=true;
  }
  initTask1();

  function checkTask1(isRetry=false){
    const total = a1.items.length;
    let newlyCorrect = 0;
    const pool = $('#pool1');

    a1.items.forEach(it=>{
      const el = document.getElementById(it.id);
      if(!el) return;
      const parent = el.parentElement;
      const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
      const ok = (placedZone === it.expect);
      if(!isRetry){
        if(ok) a1.firstCorrect.add(it.id);
      }else{
        if(ok && !a1.firstCorrect.has(it.id)) newlyCorrect++;
      }
      // richtige sperren, falsche zurück in den Ausgangskasten
      if(ok){
        el.style.boxShadow = 'inset 0 0 0 2px #a5d6a7';
        el.classList.add('locked'); el.draggable=false;
      }else{
        el.style.boxShadow = '';
        pool.appendChild(el);
      }
    });

    let points;
    if(!isRetry){
      points = computeTwoAttemptPoints(total, a1.firstCorrect.size, 0, 20);
      $('#res1').innerHTML = `Richtig im 1. Versuch: ${a1.firstCorrect.size}/${total} → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=false;
      hardDisableButton('#check1');
    }else{
  points = computeTwoAttemptPoints(total, a1.firstCorrect.size, newlyCorrect, 20);
      $('#res1').innerHTML = `Nach 2. Versuch: +${(newlyCorrect*0.5*20/total).toFixed(1)} Punkte → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=true;
      hardDisableButton('#check1');
      hardDisableButton('#retry1');
      // Nach dem 2. Versuch: alle noch falschen Wörter automatisch korrekt zuordnen und rot markieren
      a1.items.forEach(it=>{
        const el = document.getElementById(it.id);
        if(!el) return;
        const parent = el.parentElement;
        const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
        const ok = (placedZone === it.expect);
        if(!ok){
          const targetBin = it.expect === 'upper' ? $('#binUpper') : $('#binLower');
          targetBin.appendChild(el);
          el.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
          el.style.background = '#fff7f7';
        } else {
          el.style.boxShadow = 'inset 0 0 0 2px #a5d6a7';
        }
        el.classList.add('locked');
        el.draggable = false;
      });
    }
    state.scores[0] = points;
    state.attempts[0] = isRetry ? 2 : 1;
    updateScoreBar();
    updateTask1CheckEnabled();
  }

  $('#check1').addEventListener('click', ()=>checkTask1(false));
  $('#retry1').addEventListener('click', ()=>checkTask1(true));
  // Entfernt: Neuerstellen per Button (nur per Seiten-Reload)

  // Aufgabe 2
  let a2 = { data:[], firstCorrect:new Set() };
  function updateTask2CheckEnabled(){
    const all = Array.from(document.querySelectorAll('#sentences .smallcaps'));
    const decided = all.filter(sp=> (sp.dataset.choice||'') !== '');
    // Nach dem ersten Versuch bleibt der Prüfen-Button (1) dauerhaft inaktiv
    const firstAttemptAvailable = state.attempts[1] === 0;
    $('#check2').disabled = !firstAttemptAvailable || decided.length !== all.length || all.length===0;
  }
  function renderTask2(){
    a2 = { data: pickN(sentencesDB, 10), firstCorrect:new Set() };
    const container = $('#sentences'); container.innerHTML='';
    a2.data.forEach((s, si)=>{
      const card = document.createElement('div'); card.className='card sentence'; card.dataset.si = si;
      const line = document.createElement('div');
      s.tokens.forEach((tok, i)=>{
        const tinfo = s.targets.find(t=>t.i===i);
        if(tinfo){
          // Zielwort ohne angehängte Zeichensetzung in Span, Satzzeichen separat anhängen
          const m = /^(.+?)([.,;:!?]+)?$/.exec(tok) || [];
          const base = m[1] || tok;
          const punc = m[2] || '';
          const sp = document.createElement('span');
          sp.className='smallcaps pending';
          sp.textContent = deLower(base);
          sp.dataset.si = si;
          sp.dataset.ti = i;
          sp.dataset.correct = tinfo.should; // 'upper'|'lower'
          sp.dataset.choice = '';
          sp.addEventListener('click', onPopup);
          line.appendChild(sp);
          if(punc) line.append(punc);
        }else{
          line.append(tok);
        }
        if(i < s.tokens.length-1) line.append(' ');
      });
      card.appendChild(line);
      container.appendChild(card);
    });
    $('#res2').textContent='';
    $('#check2').disabled=true; $('#retry2').disabled=true;
    updateTask2CheckEnabled();
  }
  renderTask2();

  const popup = $('#popup2');
  function onPopup(ev){
    const target = ev.currentTarget;
    const rect = target.getBoundingClientRect();
    popup.style.left = Math.max(8, rect.left + window.scrollX) + 'px';
    popup.style.top = (rect.top + window.scrollY - 42) + 'px';
    popup.style.display='block';
    popup.dataset.targetSi = target.dataset.si;
    popup.dataset.targetTi = target.dataset.ti;
  }
  document.addEventListener('click', (e)=>{
    if(!popup.contains(e.target) && !e.target.classList.contains('smallcaps')){
      popup.style.display='none';
    }
  });
  popup.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const si = Number(popup.dataset.targetSi);
      const ti = Number(popup.dataset.targetTi);
      const choice = btn.dataset.choice; // 'upper'|'lower'
      const span = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${ti}"]`);
      if(span){
        span.dataset.choice = choice;
        // Schreibweise direkt im Text ändern: fett + groß/klein
        const current = span.textContent;
        const wordLower = deLower(current);
        span.style.fontWeight = '700';
        if(choice==='upper'){
          span.textContent = capFirst(wordLower);
        }else{
          span.textContent = wordLower;
        }
        span.classList.remove('pending');
      }
      popup.style.display='none';
      updateTask2CheckEnabled();
    });
  });

  function checkTask2(isRetry=false){
    let totalTargets=0, newly=0;
    const wrongSentences = new Set();
    // prüfen satzweise
    a2.data.forEach((s, si)=>{
      let sentenceOK = true;
      s.targets.forEach(t=>{
        totalTargets++;
        const span = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
        const choice = span?.dataset.choice || '';
        const ok = (choice === t.should);
        if(!ok) sentenceOK = false;
        if(!isRetry){
          if(ok){ a2.firstCorrect.add(`${si}-${t.i}`); }
        }else{
          if(ok && !a2.firstCorrect.has(`${si}-${t.i}`)) newly++;
        }
      });
      const card = $(`#task2 .sentence[data-si="${si}"]`);
      card.classList.toggle('error', !sentenceOK);
      if(!sentenceOK) wrongSentences.add(si);
    });
  const pts = computeTwoAttemptPoints(totalTargets, a2.firstCorrect.size, newly, 20);
    if(!isRetry){
      $('#res2').innerHTML = `Sätze mit Fehlern: ${wrongSentences.size} von ${a2.data.length} → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      // In allen falschen Sätzen die Zielwörter ins Ursprungsformat (smallcaps, klein, orange) zurücksetzen
      wrongSentences.forEach(si=>{
        const spans = $$(`#task2 .smallcaps[data-si="${si}"]`);
        spans.forEach(sp=>{
          sp.dataset.choice = '';
          sp.style.fontWeight = '400';
          const wordLower = deLower(sp.textContent);
          sp.textContent = wordLower;
          sp.classList.add('pending');
        });
      });
      $('#check2').disabled=true; $('#retry2').disabled=false;
      hardDisableButton('#check2');
    }else{
      $('#res2').innerHTML = `Nach 2. Versuch: korrigiert +${(newly*0.5*20/totalTargets).toFixed(1)} Punkte → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      $('#check2').disabled=true; $('#retry2').disabled=true;
      hardDisableButton('#check2');
      hardDisableButton('#retry2');
      // Nach dem 2. Versuch: falsche Zielwörter automatisch korrigieren und rot markieren
      a2.data.forEach((s, si)=>{
        s.targets.forEach(t=>{
          const sp = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
          const ok = (sp?.dataset.choice === t.should);
          if(!ok && sp){
            const base = deLower(sp.textContent);
            if(t.should==='upper'){
              sp.textContent = capFirst(base);
            }else{
              sp.textContent = base;
            }
            sp.style.fontWeight = '700';
            sp.classList.remove('pending');
            sp.style.background = '#fff7f7';
            sp.style.borderBottomColor = '#ef9a9a';
            sp.style.color = '#c62828';
          }
        });
      });
    }
    state.scores[1] = pts; state.attempts[1] = isRetry?2:1; updateScoreBar();
  }
  $('#check2').addEventListener('click', ()=>checkTask2(false));
  $('#retry2').addEventListener('click', ()=>checkTask2(true));
  // Entfernt: Neue Sätze per Button (nur per Seiten-Reload)

  // Aufgabe 3
  function storyToTokens(correctText){
    const raw = tokenize(correctText);
    return raw.map(tok=>{
      if(isWord(tok)){
        const should = /^[A-ZÄÖÜ]/.test(tok);
        return {text: tok, isWord:true, shouldCap: should};
      }else{
        return {text: tok, isWord:false, shouldCap:false};
      }
    });
  }

  let a3 = { idx:0, tokens:[], userCap:[], firstCorrect:[], clicked:[], firstUserCap:[], scoreUnitsFirst:0, maxUnits:0 };
  function initTask3(){
    const idx = rnd(storiesDB.length);
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
  a3 = { idx, tokens: toks, userCap: toks.map(t=>false), firstCorrect: toks.map(()=>false), clicked: toks.map(()=>false), firstUserCap: toks.map(()=>false), scoreUnitsFirst:0, maxUnits: toks.filter(t=>t.isWord && t.shouldCap).length };
    const host = $('#story3'); host.innerHTML='';
    toks.forEach((t, i)=>{
      const span = document.createElement('span');
      span.className = 'tok';
      span.dataset.i = i;
      if(t.isWord){
        span.textContent = deLower(t.text);
        span.addEventListener('click', ()=>{
          if(span.classList.contains('locked')) return;
          a3.userCap[i] = !a3.userCap[i];
          a3.clicked[i] = true;
          span.classList.toggle('cap', a3.userCap[i]);
          const base = deLower(t.text);
          span.textContent = a3.userCap[i] ? capFirst(base) : base;
        });
      }else{
        span.textContent = t.text;
        span.classList.add('locked');
      }
      host.appendChild(span);
      if(t.isWord) host.append(' ');
    });
    $('#res3').textContent='';
    $('#check3').disabled=false; $('#retry3').disabled=true;
  }
  initTask3();

  function checkTask3(isRetry=false){
    const words = a3.tokens.map((t,i)=>({t,i})).filter(x=>x.t.isWord);
    const mustCap = words.filter(x=>x.t.shouldCap).map(x=>x.i);
    const mustLower = words.filter(x=>!x.t.shouldCap).map(x=>x.i);
    let scoreUnits = 0; // Zählpunkte: +1 korrekt groß (nur mustCap), -1 fälschlich groß (mustLower)
    let newlyFixedMustCap = 0;
    words.forEach(({t,i})=>{
      const isCap = !!a3.userCap[i];
      if(t.shouldCap && isCap) scoreUnits += 1;
      if(!t.shouldCap && isCap) scoreUnits -= 1;
      if(isRetry){
        // Zähle neu korrekt groß gesetzte Muss-Groß-Wörter
        if(t.shouldCap && isCap && !a3.firstUserCap[i]) newlyFixedMustCap++;
      } else {
        a3.firstCorrect[i] = (isCap === t.shouldCap);
        a3.firstUserCap[i] = isCap;
      }
      const span = $(`#story3 .tok[data-i="${i}"]`);
      span.classList.remove('correct');
      if(!isRetry){
        if(t.shouldCap && isCap && a3.clicked[i]){ span.classList.add('correct'); span.classList.add('locked'); }
        else {
          const base = deLower(t.text);
          a3.userCap[i] = false; // zurücksetzen
          span.textContent = base;
          span.classList.remove('cap');
        }
      }
    });
    // Skaliere auf 30 Punkte: max +MustCap, min 0 (negative nicht unter 0)
    const maxUnits = mustCap.length;
    let scoreUnitsFinal;
    if(!isRetry){
      a3.scoreUnitsFirst = scoreUnits; // speichern fürs 2. Mal
      scoreUnitsFinal = scoreUnits;
    } else {
      scoreUnitsFinal = a3.scoreUnitsFirst + 0.5 * newlyFixedMustCap;
    }
    // Anteil bezogen auf Muss-Groß-Wörter; nicht negativ, nicht größer als maxUnits
    const norm = Math.max(0, Math.min(maxUnits, scoreUnitsFinal));
    const pts = Math.round((norm / Math.max(1, maxUnits)) * 30);
    if(!isRetry){
  const additionally = Math.max(0, mustCap.length - mustCap.filter(i=>a3.userCap[i]).length);
  $('#res3').innerHTML = `Bewertung im 1. Versuch: ${norm}/${maxUnits} → <span class="ok">${pts} Punkte</span> <span class="warn">(zusätzlich groß zu schreiben: ${additionally})</span>`;
      $('#check3').disabled=true; $('#retry3').disabled=false;
    }else{
      // Nach 2. Versuch: korrigiere Text und markiere alle weiterhin falschen Wörter rot
      words.forEach(({t,i})=>{
        const span = $(`#story3 .tok[data-i="${i}"]`);
        const should = t.shouldCap;
        const base = deLower(t.text);
        const isCap = !!a3.userCap[i];
        // Setze Text korrekt
        span.textContent = should ? capFirst(base) : base;
        span.classList.remove('correct','cap');
        span.classList.add('locked');
        if(isCap !== should){
          // falsch im 2. Versuch → rot markieren
          span.style.background = '#fff7f7';
          span.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
        }
      });
  $('#res3').innerHTML = `Nach 2. Versuch: aktualisiert → <span class="ok">${pts} Punkte</span>`;
      $('#check3').disabled=true; $('#retry3').disabled=true;
      hardDisableButton('#check3');
      hardDisableButton('#retry3');
    }
    state.scores[2] = pts; state.attempts[2] = isRetry?2:1; updateScoreBar();
  }
  $('#check3').addEventListener('click', ()=>checkTask3(false));
  $('#retry3').addEventListener('click', ()=>checkTask3(true));
  // Entfernt: Andere Geschichte per Button (nur per Seiten-Reload)

  // Aufgabe 4
  let a4 = { idx:0, tokens:[], lowerSrc:'' };
  function initTask4(){
    // pick another story different from a3.idx
    const options = storiesDB.map((_,i)=>i).filter(i=>i!==a3.idx);
    const idx = options[rnd(options.length)];
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
    a4 = { idx, tokens: toks, lowerSrc: story.toLocaleLowerCase('de-DE') }; // mit Leerzeichen
    $('#story4src').textContent = a4.lowerSrc;
    $('#story4txt').value = '';
    $('#story4feedback').innerHTML='';
    $('#res4').textContent='';
    $('#check4').disabled=true; $('#retry4').disabled=true;
    $('#c4').textContent='';
  }
  initTask4();
  // Kopieren/Markieren des Ursprungstextes unterbinden
  ['copy','cut','contextmenu','selectstart','dragstart'].forEach(evt=>{
    document.getElementById('story4src').addEventListener(evt, e=>{
      e.preventDefault();
      return false;
    });
  });

  function analyzeUserVsStory(userText, storyTokens){
    const userTokens = storyToTokens(userText); // alle Tokens inkl. Satzzeichen
    const storyWords = storyTokens.filter(t=>t.isWord);
    const total = storyWords.length;
    const result = [];
    let correctFirst=0, typos=0;

    let wi = 0; // Wortindex in der Vorlage
    for(const tok of userTokens){
      if(tok.isWord){
        let capOK=false, spellOK=false;
        if(wi < storyWords.length){
          const exp = storyWords[wi];
          const expShouldCap = exp.shouldCap;
          const gotIsCap = /^[A-ZÄÖÜ]/.test(tok.text);
          const baseExp = deLower(exp.text);
          const baseGot = deLower(tok.text);
          capOK = (expShouldCap === gotIsCap);
          spellOK = (baseExp === baseGot);
          if(capOK) correctFirst++;
          if(!spellOK) typos++;
        }
        result.push({type:'word', text: tok.text, capOK, spellOK});
        wi++;
      } else if(/[.,;:!?]/.test(tok.text)){
        result.push({type:'punct', text: tok.text});
      } else {
        // sonstige Tokens (Spaces etc.) ignorieren
      }
    }
    // Fehlende Wörter aus der Vorlage einfügen
    const missing = Math.max(0, storyWords.length - wi);
    if(missing>0){
      for(let k=wi; k<storyWords.length; k++){
        result.push({type:'missing', expected: deLower(storyWords[k].text)});
      }
    }
  const pts = (correctFirst/Math.max(1,total))*30;
  return { items: result, total, correctCount: correctFirst, typos, missing, points: Math.round(Math.max(0, Math.min(30, pts))) };
  }

  let a4first = null;
  function checkTask4(isRetry=false){
    const text = $('#story4txt').value;
    const analysis = analyzeUserVsStory(text, a4.tokens);
    if(!isRetry){
      a4first = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      // Nach dem ersten Versuch: nur Schreibfehler zeigen (keine Groß-/Kleinschreibung)
      $('#story4feedback').innerHTML = renderFeedback(analysis.items, false);
      // Hilfetext: Zähle Richtungsfehler (falsch groß vs. falsch klein)
      const wordItems = analysis.items.filter(x=>x.type==='word');
      let wrongAsUpper=0, wrongAsLower=0;
      for(let i=0;i<wordItems.length;i++){
        const shouldCap = a4.tokens.filter(t=>t.isWord)[i]?.shouldCap;
        const gotIsCap = /^[A-ZÄÖÜ]/.test(wordItems[i].text);
        if(shouldCap && !gotIsCap) wrongAsLower++;
        if(!shouldCap && gotIsCap) wrongAsUpper++;
      }
  $('#res4').innerHTML = `Richtig (Groß/Klein) im 1. Versuch: ${analysis.correctCount}/${analysis.total} → <span class="ok">${Math.round(analysis.points)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span><br/><span class="hint">Wörter, die du groß geschrieben hast, die du aber klein schreiben musst: ${wrongAsUpper}<br/>Wörter, die du klein geschrieben hast, die du aber groß schreiben musst: ${wrongAsLower}</span>`;
      state.scores[3] = analysis.points;
      $('#check4').disabled=true; $('#retry4').disabled=false;
      // Ersten Prüfen-Button hart deaktivieren, damit er nicht erneut aktiv wird
      hardDisableButton('#check4');
    }else{
      const now = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      let newly=0;
      for(let i=0;i<now.length;i++){
        if(now[i] && a4first && !a4first[i]) newly++;
      }
  const pts = computeTwoAttemptPoints(analysis.total, (a4first||[]).filter(Boolean).length, newly, 30);
    // Im zweiten Versuch: alle Fehler inkl. Groß-/Kleinschreibung anzeigen
    $('#story4feedback').innerHTML = renderFeedback(analysis.items, true);
  $('#res4').innerHTML = `Nach 2. Versuch: +${Math.round(newly*0.5*30/analysis.total)} Punkte → <span class="ok">${Math.round(pts)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span>`;
  hardDisableButton('#check4');
  hardDisableButton('#retry4');
      state.scores[3] = pts;
      $('#check4').disabled=true; $('#retry4').disabled=true;
      state.attempts[3] = 2;
    }
    updateScoreBar();
  }
  function renderFeedback(items, showCap=true){
    const style = 'padding:2px 4px; border-radius:6px; margin-right:4px; display:inline-block';
    const out = [];
    for(const x of items){
      if(x.type==='punct'){
        // Satzzeichen direkt anhängen (ohne zusätzliches Leerzeichen davor)
        const last = out.length ? out.pop() : '';
        const merged = (last || '') + `${x.text}`;
        out.push(merged);
        continue;
      }
      if(x.type==='missing'){
        out.push(`<span class="mark-typo" style="${style}">[${x.expected}]</span>`);
        continue;
      }
      // Wörter
      let cls = x.capOK ? 'correct' : 'mark-cap';
      if(!showCap){
        // Groß-/Kleinschreibung im 1. Versuch ausblenden; nur Schreibfehler zeigen
        cls = x.spellOK ? '' : 'mark-typo';
      } else {
        if(!x.spellOK) cls = 'mark-typo';
      }
      const token = cls ? `<span class="${cls}" style="${style}">${x.text}</span>` : `${x.text}`;
      out.push(token);
    }
    // Wörter mit Leerzeichen verbinden; Satzzeichen sind bereits ohne Extraleerzeichen angefügt
    return out.join(' ');
  }
  $('#check4').addEventListener('click', ()=>checkTask4(false));
  $('#retry4').addEventListener('click', ()=>checkTask4(true));
  // Entfernt: Andere Geschichte per Button (nur per Seiten-Reload)
  $('#story4txt').addEventListener('input', ()=>{
    const v = $('#story4txt').value;
    const w = v.trim().split(/\s+/).filter(Boolean).length;
    $('#c4').textContent = `Wörter: ${w}`;
    // Prüfen erst möglich, wenn etwas geschrieben wurde und mind. ein Leerzeichen vorhanden ist
    if(state.attempts[3] === 0){
      $('#check4').disabled = !(v.trim().length>0 && /\s/.test(v));
    } else {









      $('#check4').disabled = true;
    }
  });

  // Aufgabe 5: Diktat
  const diktatSentences = [
    { correct: 'Ich habe eine neue Wohnung in der Innenstadt.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' },
    { correct: 'Die Möbel stehen schon im Wohnzimmer.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' },
    { correct: 'Wir müssen noch das Schlafzimmer tapezieren.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' },
    { correct: 'Am Samstag helfen mir meine Freunde beim Umzug.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' },
    { correct: 'Ich freue mich auf meine neuen Nachbarn.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' },
    { correct: 'Die Monatsmiete ist teuer, weil die Nebenkosten hoch sind.', audio: 'https://ritterplan-portal.de/client/resources/Toiletten/1.mp3' }
  ];

  function initTask5(){
    const container = $('#diktat-sentences');
    if(!container) return;
    container.innerHTML = '';
    diktatSentences.forEach((s, idx)=>{
      const row = document.createElement('div');
      row.className = 'row';
      row.style.alignItems = 'center';
      row.style.marginBottom = '12px';
      
      const playBtn = document.createElement('button');
      playBtn.className = 'secondary';
      playBtn.innerHTML = '▶ Abspielen';
      playBtn.style.minWidth = '120px';
      playBtn.addEventListener('click', ()=>{
        const audio = new Audio(s.audio);
        audio.play().catch(err=>{
          alert('Audiodatei konnte nicht abgespielt werden. Bitte Audio-URL setzen.');
        });
      });
      
      const input = document.createElement('input');
      input.type = 'text';
      input.id = `diktat${idx}`;
      input.placeholder = `Satz ${idx+1} hier eingeben...`;
      input.style.flex = '1';
      input.style.padding = '10px';
      input.style.border = '1px solid var(--border)';
      input.style.borderRadius = '8px';
      input.style.fontSize = '1rem';
      input.autocomplete = 'off';
      input.addEventListener('paste', (e)=>{
        e.preventDefault();
        return false;
      });
      input.addEventListener('contextmenu', (e)=>{
        e.preventDefault();
        return false;
      });
      input.addEventListener('input', updateTask5CheckEnabled);
      
      row.appendChild(playBtn);
      row.appendChild(input);
      container.appendChild(row);
    });
    $('#res5').textContent = '';
    $('#check5').disabled = true;
    $('#retry5').disabled = true;
  }
  initTask5();

  function updateTask5CheckEnabled(){
    if(state.attempts[4] > 0){
      $('#check5').disabled = true;
      return;
    }
    const allFilled = diktatSentences.every((s, idx)=>{
      const input = $(`#diktat${idx}`);
      return input && input.value.trim().length > 0;
    });
    $('#check5').disabled = !allFilled;
  }

  function checkTask5(isRetry=false){
    let totalErrors = 0;
    let sentenceScores = [];
    
    diktatSentences.forEach((s, idx)=>{
      const input = $(`#diktat${idx}`);
      const userText = input.value.trim();
      const correctTokens = storyToTokens(s.correct).filter(t=>t.isWord);
      const userTokens = storyToTokens(userText).filter(t=>t.isWord);
      
      let errors = 0;
      let correctWords = 0;
      const maxLen = Math.max(correctTokens.length, userTokens.length);
      
      for(let i=0; i<maxLen; i++){
        if(i >= correctTokens.length || i >= userTokens.length){
          errors++;
          continue;
        }
        const expWord = correctTokens[i];
        const gotWord = userTokens[i];
        
        const expShouldCap = expWord.shouldCap;
        const gotIsCap = /^[A-ZÄÖÜ]/.test(gotWord.text);
        const expBase = deLower(expWord.text);
        const gotBase = deLower(gotWord.text);
        
        let wordCorrect = true;
        if(expShouldCap !== gotIsCap) {
          errors++;
          wordCorrect = false;
        }
        if(expBase !== gotBase) {
          errors++;
          wordCorrect = false;
        }
        if(wordCorrect) correctWords++;
      }
      
      // Bewertung: 0 Punkte wenn kein Wort richtig, sonst 0-10 Fehler -> 5-0 Punkte
      let pts;
      if(correctWords === 0 && correctTokens.length > 0){
        pts = 0;
      } else {
        pts = Math.max(0, 5 - (errors * 0.5));
      }
      sentenceScores.push({idx, errors, points: pts});
      totalErrors += errors;
      
      // Visuelles Feedback
      if(errors === 0){
        input.style.borderColor = '#2e7d32';
        input.style.background = '#e8f5e9';
      } else if(errors <= 2){
        input.style.borderColor = '#ef6c00';
        input.style.background = '#fff3e0';
      } else {
        input.style.borderColor = '#c62828';
        input.style.background = '#ffebee';
      }
    });
    
    const totalPoints = sentenceScores.reduce((sum, s)=>sum + s.points, 0);
    
    if(!isRetry){
      let feedback = sentenceScores.map(s=>
        `Satz ${s.idx+1}: ${s.errors} Fehler → ${s.points.toFixed(1)} Punkte`
      ).join('<br/>');
      $('#res5').innerHTML = `<span class="ok">Gesamt: ${totalPoints.toFixed(1)} / 30 Punkte</span><br/>${feedback}`;
      $('#check5').disabled = true;
      $('#retry5').disabled = false;
      hardDisableButton('#check5');
      state.scores[4] = totalPoints;
      state.attempts[4] = 1;
    } else {
      let feedback = sentenceScores.map(s=>
        `Satz ${s.idx+1}: ${s.errors} Fehler → ${s.points.toFixed(1)} Punkte`
      ).join('<br/>');
      $('#res5').innerHTML = `<span class="ok">Nach 2. Versuch: ${totalPoints.toFixed(1)} / 30 Punkte</span><br/>${feedback}`;
      $('#check5').disabled = true;
      $('#retry5').disabled = true;
      hardDisableButton('#check5');
      hardDisableButton('#retry5');
      state.scores[4] = totalPoints;
      state.attempts[4] = 2;
    }
    
    updateScoreBar();
  }

  $('#check5').addEventListener('click', ()=>checkTask5(false));
  $('#retry5').addEventListener('click', ()=>checkTask5(true));

  // Init Punkte
  updateScoreBar();

})();
</script>
</body>
</html>