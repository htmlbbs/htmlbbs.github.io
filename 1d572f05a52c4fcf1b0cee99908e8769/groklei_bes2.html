<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>BES: Groß- und Kleinschreibung – A2 (mit Fachwahl)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#152038;
      --muted:#5b6475;
      --accent:#2962ff;
      --ok:#2e7d32;
      --warn:#ef6c00;
      --bad:#c62828;
      --chip:#eef2ff;
      --drop:#e8f5e9;
      --drop2:#fff3e0;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --border:#e3e6ef;
      --cap:#0d47a1;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink); background:var(--bg) }
    header{ position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#ffffff 0%, #fafbff 100%); border-bottom:1px solid var(--border) }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px 20px }
    h1{ font-size:1.35rem; margin:0 0 6px 0 }
    h2{ font-size:1.2rem; margin:0 0 8px 0 }
    .desc{ color:var(--muted); margin-bottom:12px }
    main .section{ background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; margin:16px auto; box-shadow:var(--shadow) }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start }
    .btnbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px }
    button{ appearance:none; border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; box-shadow:0 2px 10px rgba(41,98,255,.25) }
    button.secondary{ background:#e8ebf8; color:#1b2a6f; box-shadow:none }
    button.ghost{ background:transparent; color:var(--muted); box-shadow:none }
    button:disabled{ opacity:.5; cursor:not-allowed }
    .badge{ display:inline-block; padding:2px 8px; border-radius:12px; background:#f0f4ff; color:#1b2a6f; font-size:.82rem; margin-left:6px }
    .scorebar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:.95rem }
    .scorebar .pill{ background:var(--card); border:1px solid var(--border); border-radius:100px; padding:6px 10px }
    .pill.neutral{ background:var(--card); color:inherit; border-color:var(--border) }
    .pill.danger{ background:#fdecea; color:#b71c1c; border-color:#f5c6cb }
    .pill.bad{ background:#ffebee; color:#c62828; border-color:#ffcdd2 }
    .pill.mid{ background:#fff9c4; color:#7a6e00; border-color:#fff59d }
    .pill.ok{ background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9 }
    .pill.good{ background:#d0f0d7; color:#1b5e20; border-color:#b2dfbd }
    .pill.excellent{ background:#c8e6c9; color:#1b5e20; border-color:#a5d6a7 }
    .chip{ display:inline-flex; align-items:center; gap:6px; background:var(--chip); border:1px solid #d6dcff; color:#1b2a6f; padding:8px 10px; border-radius:999px; cursor:grab; user-select:none; transition:.15s transform ease }
    .chip:active{ transform:scale(.97); cursor:grabbing }
    .bins{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .bin{ min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fafbff }
    .bin.gr{ background:var(--drop) }
    .bin.kl{ background:var(--drop2) }
    .pool{ min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fff }
    .smallcaps{ font-variant:small-caps; letter-spacing:.03em; color:var(--cap); border-bottom:1px dotted #90caf9; cursor:pointer }
    .smallcaps.pending{ background:#ffe0b2; color:#8a4b00; padding:0 2px; border-radius:4px }
    .popup{ position:absolute; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); padding:6px; display:none; z-index:10 }
    .popup button{ padding:6px 10px; margin:2px; box-shadow:none }
    .sentence{ line-height:1.7 }
    .card{ border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff }
    .locked{ opacity:.65; pointer-events:none }
    .ok{ color:var(--ok) } .bad{ color:var(--bad) } .warn{ color:var(--warn) }
    .result{ font-weight:700 }
    .texttokens{ line-height:1.9 }
    .tok{ padding:2px 2px; border-radius:4px; cursor:pointer }
    .tok.cap{ background:#e3f2fd; border:1px solid #bbdefb }
    .tok.correct{ box-shadow:inset 0 0 0 2px #a5d6a7 }
    .preview{ border:1px dashed var(--border); border-radius:10px; padding:10px; background:#fcfcff }
    #story4src{ font-size:1.2rem; user-select:none }
    .mark-cap{ background:#fff3cd }
    .mark-typo{ background:#ffebee }
    textarea{ width:100%; min-height:140px; resize:vertical; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:1.4rem }
    .counter{ color:var(--muted); font-size:.92rem }
    footer{ color:var(--muted); padding-bottom:40px }
    .pill.info{ background:#eef7ff; border-color:#d6eaff; color:#0b5cad }
    .selectbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    select{ padding:8px 10px; border:1px solid var(--border); border-radius:8px; font-weight:600 }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Übungen: Groß- und Kleinschreibung – mit Fachrichtung für BE2</h1>
    <div class="selectbar">
      <label for="fach">Fachrichtung wählen:</label>
      <select id="fach">
        <option value="Gastronomie">Gastronomie</option>
        <option value="Hauswirtschaft">Hauswirtschaft</option>
        <option value="Körperpflege">Körperpflege</option>
      </select>
      <button id="start" class="secondary">Neu laden</button>
      <span class="pill info">Tipp: Nach Abschluss kannst du hier neu laden, um zufällige neue Aufgaben zu erhalten.</span>
    </div>
  </div>
</header>

<main class="wrap">

  <section class="section" id="task1">
    <h2>Aufgabe 1 – Wörter zu „groß“ oder „klein“ ziehen <span class="badge">20 Punkte</span></h2>
    <div class="desc">Aufgabe: „Wie wird dieses Wort im Satz (nicht am Satzanfang) geschrieben?“ Ziehe jedes Wort in das richtige Feld.</div>
    <div class="row">
      <div class="card" style="flex:1">
        <div class="bin-title">Nicht sortiert</div>
        <div id="pool1" class="pool" data-accept="any"></div>
      </div>
    </div>
    <div class="bins">
      <div class="card">
        <div class="bin-title">groß (Nomen, Eigennamen)</div>
        <div id="binUpper" class="bin gr" data-accept="upper"></div>
      </div>
      <div class="card">
        <div class="bin-title">klein (Verben, Adjektive, Präpositionen, Artikel)</div>
        <div id="binLower" class="bin kl" data-accept="lower"></div>
      </div>
    </div>
    <div class="btnbar">
      <button id="check1" disabled>Prüfen – Versuch 1</button>
      <button id="retry1" class="secondary" disabled>Zweiter Versuch</button>
      <span class="desc">Max. 20 Punkte. Im 2. Versuch halbe Punkte je nachträglich richtigem Wort.</span>
    </div>
    <div class="result" id="res1"></div>
  </section>

  <section class="section" id="task2">
    <h2>Aufgabe 2 – Wähle „groß/klein“ in Sätzen <span class="badge">20 Punkte</span></h2>
    <div class="desc">In jedem Satz sind zwei Wörter markiert. Klicke sie an und wähle, ob sie groß oder klein geschrieben werden.</div>
    <div id="sentences" class="area"></div>
    <div class="btnbar">
      <button id="check2" disabled>Prüfen – Versuch 1</button>
      <button id="retry2" class="secondary" disabled>Zweiter Versuch</button>
    </div>
    <div class="popup" id="popup2">
      <button data-choice="upper">groß</button>
      <button data-choice="lower">klein</button>
    </div>
    <div class="result" id="res2"></div>
  </section>

  <section class="section" id="task3">
    <h2>Aufgabe 3 – Klicke die Wörter groß <span class="badge">30 Punkte</span></h2>
    <div class="desc">Alle Wörter sind klein geschrieben. Klicke Wörter, die groß geschrieben werden müssen (Satzanfänge, Nomen, Namen, Länder/Städte).</div>
    <div id="story3" class="card texttokens"></div>
    <div class="btnbar">
      <button id="check3">Prüfen – Versuch 1</button>
      <button id="retry3" class="secondary" disabled>Zweiter Versuch</button>
    </div>
    <div class="result" id="res3"></div>
  </section>

  <section class="section" id="task4">
    <h2>Aufgabe 4 – Richtig abschreiben <span class="badge">30 Punkte</span></h2>
    <div class="desc">
      Schreibe die klein geschriebene Geschichte in das Textfeld ab – mit korrekter Groß-/Kleinschreibung.<br/>
      <b>Bitte vergesse beim Abschreiben keine Wörter. Dann funktioniert die Korrektur nicht!</b><br/>
      (Schreibfehler werden markiert, zählen aber nicht zur Punktzahl.)
    </div>
    <div id="story4src" class="preview mono"></div>
    <div class="row"><textarea id="story4txt" spellcheck="false" placeholder="Hier korrekt abschreiben …"></textarea></div>
    <div class="btnbar">
      <button id="check4" disabled>Prüfen – Versuch 1</button>
      <button id="retry4" class="secondary" disabled>Zweiter Versuch</button>
      <span class="counter" id="c4"></span>
    </div>
    <div class="preview" id="story4feedback"></div>
    <div class="result" id="res4"></div>
  </section>

  <section class="wrap section" id="summary">
    <h2>Punkte</h2>
    <div class="scorebar" id="scorebarBottom">
      <div class="pill" id="totalPill">Gesamt: <span id="totalScore">0</span> / 100</div>
      <div class="pill" id="pill1">A1: <span id="s1">0</span>/20</div>
      <div class="pill" id="pill2">A2: <span id="s2">0</span>/20</div>
      <div class="pill" id="pill3">A3: <span id="s3">0</span>/30</div>
      <div class="pill" id="pill4">A4: <span id="s4">0</span>/30</div>
    </div>
    <div id="completeInfo" class="result ok" style="display:none; margin-top:8px">Alle Aufgaben abgeschlossen: Jede Aufgabe ist entweder vollständig richtig oder nach zwei Versuchen beendet.</div>
    <div id="reloadTip" class="desc" style="display:none">Tipp: Oben die Fachrichtung wechseln oder Seite neu laden, um andere zufällige Inhalte zu erhalten.</div>
  </section>

</main>

<footer class="wrap"></footer>

<script>
(function(){
  const rnd = (n)=>Math.floor(Math.random()*n);
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const pickN = (arr, n)=>shuffle(arr.slice()).slice(0,n);
  const deLower = s => s.toLocaleLowerCase('de-DE');
  const deUpper = s => s.toLocaleUpperCase('de-DE');
  const capFirst = s => s.replace(/^([a-zäöüß])/i, (m)=>m.toLocaleUpperCase('de-DE'));
  const isWord = (t)=>/^[A-Za-zÄÖÜäöüß\\-]+$/.test(t);
  const stripPunct = (t)=>t.replace(/^[^\\p{L}]+|[^\\p{L}]+$/gu,'');
  const tokenize = (text)=>{
    const parts = [];
    let m, re = /([A-Za-zÄÖÜäöüß\\-]+|[0-9]+|[^\\sA-Za-zÄÖÜäöüß0-9\\-]+)/g;
    let last = 0;
    while((m=re.exec(text))!==null){
      const idx = m.index;
      if(idx>last){
        const gap = text.slice(last, idx);
      }
      parts.push(m[0]);
      last = idx + m[0].length;
    }
    return parts;
  };
  const $ = sel=>document.querySelector(sel);
  const $$ = sel=>Array.from(document.querySelectorAll(sel));

  const DATA = {
    Gastronomie: {
      NOUNS: [
        'der Koch','die Köchin','die Küche','das Restaurant','die Speisekarte','die Bestellung','der Gast','die Gäste','der Kellner','die Kellnerin',
        'der Tisch','der Teller','das Glas','die Tasse','der Löffel','die Gabel','das Messer','die Serviette','das Tablett','die Rechnung',
        'das Trinkgeld','die Kasse','der Ofen','der Herd','der Kühlschrank','die Pfanne','der Topf','das Schneidebrett','das Messer','die Zange',
        'der Salat','die Suppe','das Brot','die Nudeln','der Reis','das Gemüse','das Obst','das Fleisch','der Fisch','das Getränk',
        'der Kaffee','der Tee','die Limo','das Wasser','das Dessert','der Kuchen','das Eis','das Frühstück','das Mittagessen','das Abendessen',
        'die Reservierung','der Arbeitsplatz','die Hygieneregeln','die Schürze','die Mütze','die Handschuhe','die Spülküche','die Spülmaschine','der Lieferant','die Bestellung'
      ],
      VERBS: [
        'kochen','backen','braten','schneiden','würzen','mischen','wiegen','rühren','spülen','servieren',
        'bestellen','bezahlen','reservieren','abräumen','decken','liefern','prüfen','kühlen','erhitzen','aufwärmen',
        'abschmecken','anrichten','abwiegen','abholen','verkaufen','auftragen','nachfüllen','aufsetzen','aufkochen','abschalten',
        'reinigen','kontrollieren','aufbewahren','lagern','auflisten','aufnehmen','notieren','planen','warten','erklären'
      ],
      ADJS: ['heiß','kalt','scharf','mild','salzig','süß','sauer','frisch','fertig','leer','voll','sauber','ordentlich','schnell','langsam','pünktlich','freundlich','nett','wichtig','richtig'],
      // 80 Sätze: 50 gemischt (1 upper + 1 lower), 15 upper+upper, 15 lower+lower
      SENTENCES: [
        // Gemischt 1–50
        { tokens:['Im','Restaurant','bringt','die','Kellnerin','die','Rechnung.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Koch','würzt','die','Suppe','mit','Salz.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Bitte','decken','Sie','den','Tisch','für','vier','Gäste.'], targets:[{i:4,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Arne','schneidet','Gemüse','und','rührt','die','Soße.'], targets:[{i:6,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','reserviert','Mia','einen','Platz','am','Fenster.'], targets:[{i:6,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Im','Kühlschrank','stehen','Milch','und','Joghurt.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Gast','bezahlt','mit','Karte','oder','bar.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','spülen','die','Teller','und','Gläser.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Im','Service','ist','freundliches','Verhalten','wichtig.'], targets:[{i:4,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Bitte','tragen','Sie','eine','Schürze','in','der','Küche.'], targets:[{i:7,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','Mittag','kommt','die','Lieferung','mit','Gemüse.'], targets:[{i:6,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Im','Ofen','backt','der','Koch','einen','Kuchen.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Die','Gäste','warten','auf','den','Kellner.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['In','der','Küche','schneiden','wir','Gemüse.'], targets:[{i:5,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Heute','braten','wir','Fisch','und','Reis.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Ofen','heizt','für','den','Kuchen','vor.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','wiegen','das','Fleisch','für','die','Pfanne.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Kellnerin','notiert','eine','Bestellung.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Koch','mischt','Salat','und','Soße.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','rühren','die','Suppe','im','Topf.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','backen','wir','Brot','im','Ofen.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Die','Gabel','liegt','neben','dem','Teller.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','servieren','heute','Nudeln','und','Gemüse.'], targets:[{i:5,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Im','Kühlschrank','kühlen','Getränke','und','Desserts.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Kellner','bringt','Gläser','zum','Tisch.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','füllen','die','Tassen','mit','Tee.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','schreiben','wir','die','Speisekarte.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Im','Service','räumen','wir','Teller','ab.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Gast','lobt','die','Köchin','für','den','Kuchen.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','prüfen','die','Reservierung','noch','einmal.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Lieferung','enthält','Milch','und','Joghurt.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Heute','reinigen','wir','Tabletts','und','Tassen.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','notieren','den','Verbrauch','von','Öl.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Topf','steht','auf','dem','Herd.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','lagern','das','Gemüse','im','Keller.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Koch','plant','das','Mittagessen.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','erhitzen','die','Soße','im','Topf.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Pfanne','steht','neben','dem','Herd.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Im','Schrank','liegen','Tassen','und','Gläser.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','bereiten','ein','Dessert','mit','Obst.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Gäste','bestellen','Kaffee','und','Kuchen.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Heute','verkaufen','wir','mehr','Getränke.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Kellner','trägt','Tabletts','zum','Tisch.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','richten','die','Teller','schön','an.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Köchin','macht','Nudeln','aus','Mehl.'], targets:[{i:3,should:'upper'},{i:4,should:'lower'}] },
        { tokens:['Wir','backen','heute','Kuchen','und','Brot.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Gast','lobt','den','Service','im','Restaurant.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','decken','den','Tisch','für','Gäste.'], targets:[{i:5,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','portionieren','wir','den','Salat.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Die','Kellnerin','stellt','Gläser','auf','den','Tisch.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','kontrollieren','die','Temperatur','mehrmals','täglich.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Ofen','schaltet','gleich','ab.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','messen','die','Menge','für','den','Teig.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Bestellung','enthält','Reis','und','Fisch.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Heute','probieren','wir','ein','Dessert.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Der','Salat','steht','auf','dem','Buffet.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
        // Upper+Upper 51–65
  { tokens:['Die','Schürze','liegt','sauber','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Koch','prüft','Kräuter','und','Öl.'], targets:[{i:1,should:'upper'},{i:3,should:'upper'}] },
  { tokens:['Im','Lager','liegen','Kisten','mit','Obst.'], targets:[{i:1,should:'upper'},{i:3,should:'upper'}] },
  { tokens:['Die','Pfannen','trocknen','an','der','Luft.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Der','Teller','steht','auf','einem','Tablett.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Die','Gläser','glänzen','nach','dem','Polieren.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Der','Ofen','kühlt','langsam','aus.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Speisekarte','hängt','heute','frisch','aus.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Gast','fragt','nach','Allergenen.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Die','Lieferung','kommt','pünktlich','an.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Kaffee','duftet','frisch','heute.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Desserts','stehen','kalt','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Reis','quillt','gleichmäßig','auf.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Soße','köchelt','leise','weiter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Service','läuft','ruhig','weiter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
        // Lower+Lower 66–80
        { tokens:['Wir','prüfen','heute','gründlich','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','arbeiten','wir','ruhig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','schneiden','fein','gleichmäßig.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','servieren','wir','vorsichtig','heiß.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','mischen','heute','schnell','fertig.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','portionieren','wir','sorgfältig','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','räumen','gleich','leise','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','verpacken','wir','sauber','fertig.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','wiegen','heute','sorgfältig','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','probieren','wir','ruhig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','richten','heute','ruhig','an.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','backen','wir','konstant','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','reinigen','heute','gründlich','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','lagern','wir','geordnet','ein.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','portionieren','gleich','gleichmäßig.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] }
      ],
      STORIES: [
        'Im Restaurant bereiten wir das Mittagessen vor. Die Köchin schneidet Gemüse und würzt die Suppe. Der Kellner deckt die Tische und stellt Gläser bereit.',
        'Heute kommt eine große Gruppe. Wir prüfen die Reservierung und zählen Teller. In der Küche braten wir Fleisch und kochen Reis.',
        'Am Morgen kontrollieren wir die Kühlung. Salat ist frisch und Soßen stehen bereit. Danach putzen wir die Arbeitsfläche gründlich.',
        'Lea nimmt die Bestellung auf und fragt freundlich nach Allergien. Später bringt sie die Rechnung an den Tisch.',
        'Im Lager sortieren wir die Lieferung. Wir räumen Milch und Joghurt ein und prüfen die Temperatur.',
        'Das Team übt heute im Schulrestaurant. Zwei Schüler kochen Nudeln, andere servieren Getränke. Am Ende räumen alle zusammen ab.',
        'Vor dem Mittag prüfen wir den Vorrat. Fehlende Gewürze ergänzen wir und stellen frische Kräuter bereit.',
        'Am Abend reinigen wir die Küche gründlich. Backöfen kühlen ab und Bleche trocknen auf Gestellen.',
        'Nach der Lieferung kontrollieren wir die Kühlkette. Warme Produkte melden wir sofort der Lehrkraft.',
        'Die Auszubildenden planen ein Menü. Sie wiegen Zutaten und bereiten Stationen strukturiert vor.',
        'Im Service trainieren wir das sichere Tragen von Tabletts. Ruhige Schritte verhindern Verschütten.',
        'Bei einer Beschwerde hören wir zuerst ruhig zu. Dann suchen wir eine Lösung und bedanken uns für den Hinweis.',
        'Heute testen wir neue Desserts. Kleine Portionen richten wir an und bewerten Aussehen und Geschmack.',
        'Nach dem Andrang spülen wir viele Teller. Wir polieren Gläser und stellen sie sortiert in den Schrank.',
        'Im Kühlraum ordnen wir alles nach Datum. Ältere Ware rückt nach vorne, neue markieren wir deutlich.',
        'Wir dokumentieren Temperaturen schriftlich. Abweichungen melden wir sofort und leiten Maßnahmen ein.',
        'Vor der Pause sichern wir offene Lebensmittel. Wir schließen Behälter und stellen sie rasch zurück.',
        'Das Team trainiert heute Kommunikation. Kurze klare Anweisungen erleichtern Zusammenarbeit.',
        'Bei Allergien zeigen wir Zutatenlisten. Gäste erhalten passende Empfehlungen ohne Risiko.',
        'Zum Schluss planen wir den nächsten Tag. Wir erstellen Listen und sortieren benötigte Geräte.'
      ]
    },
    Hauswirtschaft: {
      NOUNS: [
        'der Haushalt','die Küche','das Badezimmer','das Wohnzimmer','das Schlafzimmer','die Waschmaschine','der Trockner','das Waschmittel','der Besen','der Staubsauger',
        'der Lappen','der Eimer','das Putzmittel','der Müll','die Mülltonne','der Abfall','der Kühlschrank','das Regal','der Schrank','der Tisch',
        'der Stuhl','die Spüle','der Wasserhahn','das Geschirr','das Besteck','die Pfanne','der Topf','das Brett','der Ofen','der Herd',
        'der Plan','die Liste','die Aufgabe','die Ordnung','die Hygiene','der Einkauf','der Wochenplan','die Kasse','die Kasse','der Bon',
        'die Wäsche','das Hemd','die Hose','die Socken','das Handtuch','die Bettwäsche','der Fleck','die Bürste','die Seife','der Lappen',
        'die Sicherheit','die Handschuhe','die Maske','die Lüftung','die Oberfläche','das Desinfektionsmittel'
      ],
      VERBS: [
        'putzen','wischen','saugen','aufräumen','sortieren','waschen','trocknen','falten','bügeln','lüften',
        'spülen','entsorgen','trennen','planen','einkaufen','auflisten','notieren','kontrollieren','prüfen','desinfizieren',
        'decken','abräumen','kochen','backen','lagern','kühlen','ordnen','wechseln','reinigen','abspülen',
        'einräumen','ausräumen','abwischen','aufschreiben','einhalten','beachten','sichern','aufpassen','warnen','erklären'
      ],
      ADJS: ['sauber','ordentlich','trocken','feucht','frisch','voll','leer','wichtig','richtig','schnell','langsam','pünktlich','deutlich','vorsichtig','sicher','warm','kalt','hell','dunkel','leise'],
      // 80 Sätze Hauswirtschaft (50 gemischt, 15 upper+upper, 15 lower+lower)
      SENTENCES: [
        // Gemischt 1–50
  { tokens:['Heute','putzen','wir','die','Küche','und','das','Bad.'], targets:[{i:4,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Bitte','trennen','Sie','den','Müll','richtig.'], targets:[{i:4,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Im','Plan','steht','die','Einkaufsliste.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Lara','wäscht','die','Wäsche','und','faltet','sie.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Staubsauger','ist','kaputt','und','macht','Lärm.'], targets:[{i:6,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Im','Schrank','liegen','Teller','und','Gläser.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','desinfizieren','die','Oberflächen','nach','dem','Kochen.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Bitte','lüften','Sie','das','Zimmer','zehn','Minuten.'], targets:[{i:6,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Tom','schreibt','eine','Liste','für','den','Einkauf.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Waschmaschine','läuft','vierzig','Minuten.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Im','Regal','stehen','Becher','und','Schalen.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Heute','räumen','wir','den','Kühlschrank','auf.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','sortieren','die','Wäsche','nach','Farben.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Liste','enthält','Seife','und','Tücher.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','falten','Handtücher','für','das','Regal.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','reinigen','wir','Arbeitsflächen','mit','Mittel.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','wechseln','die','Bettwäsche','heute','früh.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Maske','schützt','unsere','Haut.'], targets:[{i:4,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','notieren','den','Wochenplan','im','Heft.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Fleck','geht','mit','Seife','weg.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','lüften','die','Zimmer','nach','dem','Putzen.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Oberfläche','wirkt','sauber','und','trocken.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','spülen','Teller','und','Besteck','gründlich.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Besens','Stiel','steht','in','der','Ecke.'], targets:[{i:6,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','wischen','den','Boden','heute','zweimal.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Handschuhe','liegen','auf','dem','Tisch.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','trennen','Glas','und','Kunststoff.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Eimer','steht','neben','der','Spüle.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','sichern','die','Oberfläche','mit','Folie.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Seife','duftet','frisch','und','mild.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','fegen','den','Vorraum','am','Abend.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Die','Tücher','trocknen','auf','der','Leine.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Wir','packen','Werkzeug','in','den','Schrank.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Plan','ändert','sich','am','Wochenende.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','erstellen','eine','Liste','für','Einkäufe.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Waschmaschine','läuft','leise','am','Abend.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','heizen','den','Trockner','vor.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Stuhl','steht','im','Arbeitsraum.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Wir','bügeln','Hemden','und','Hosen.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Schrank','braucht','neue','Ordnung.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','sammeln','den','Abfall','im','Sack.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Staub','liegt','auf','dem','Regal.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Wir','nehmen','Proben','für','eine','Kontrolle.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Kacheln','glänzen','nach','dem','Putzen.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','markieren','den','Termin','im','Plan.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Bon','liegt','an','der','Kasse.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Wir','reinigen','Fenster','mit','Mikrofasertuch.'], targets:[{i:2,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Aufgabe','wirkt','heute','einfach.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','verpacken','die','Handtücher','staubfrei.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Lappen','trocknet','auf','der','Heizung.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        // Upper+Upper 51–65
  { tokens:['Der','Schwamm','liegt','feucht','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Flasche','steht','ordentlich','da.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Eimer','trocknet','langsam','aus.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Liste','hängt','sichtbar','oben.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Regalboden','trägt','schwere','Kisten.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Die','Türe','schließt','fest','ein.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Spiegel','zeigt','Staub','stellenweise.'], targets:[{i:1,should:'upper'},{i:3,should:'upper'}] },
  { tokens:['Die','Arbeitsplatte','bleibt','trocken','heute.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Schrank','steht','stabil','gerade.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Waschküche','riecht','frisch','jetzt.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Abfluss','läuft','sauber','weiter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Bürste','steht','aufrecht','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Filter','sitzt','fest','drin.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Scheibe','glänzt','klar','heute.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Putzwagen','rollt','leise','weiter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
        // Lower+Lower 66–80
        { tokens:['Wir','reinigen','heute','gründlich','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','arbeiten','wir','ruhig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','wischen','heute','vorsichtig','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','sortieren','wir','sorgfältig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','packen','heute','leise','fertig.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','verpacken','wir','sauber','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','falten','heute','ruhig','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','prüfen','wir','strukturiert','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','dokumentieren','heute','sorgfältig','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','notieren','wir','gründlich','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','sammeln','heute','geordnet','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','räumen','wir','leise','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','polieren','heute','gleichmäßig','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','wechseln','wir','systematisch','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','lagern','heute','geordnet','ein.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] }
      ],
      STORIES: [
        'Am Morgen erstellen wir einen Wochenplan. Danach kaufen wir ein und kontrollieren Vorräte. Am Nachmittag reinigen wir Küche und Bad.',
        'Heute waschen wir die Wäsche. Wir sortieren Farben, starten die Maschine und hängen danach alles ordentlich auf.',
        'Im Haushalt ist Ordnung wichtig. Wir wischen den Boden, saugen das Wohnzimmer und entsorgen am Ende den Müll.',
        'Im Kühlschrank sortieren wir Lebensmittel nach Datum. Alte Produkte kommen nach vorne, neue markieren wir deutlich.',
        'Die Klasse deckt gemeinsam den Tisch. Teller, Gläser und Besteck liegen bereit. Nach dem Essen räumen wir alles ab.',
        'Wir üben Sicherheitsregeln: Handschuhe tragen, Fenster öffnen, Putzmittel korrekt dosieren. So bleibt die Arbeit sicher.',
        'Vor der Pause planen wir Aufgaben. Wir erstellen Listen und prüfen Material. Danach verteilen wir Verantwortungen.',
        'Nach dem Mittag reinigen wir Geräte gründlich. Filter trocknen an der Luft. Defekte Teile melden wir sofort.',
        'Wir kontrollieren Vorräte sorgfältig. Fehlende Reinigungsmittel notieren wir und bestellen zeitnah nach.',
        'Beim Sortieren achten wir auf Datum. Ältere Lebensmittel rücken nach vorne. Neue Ware beschriften wir klar.',
        'Wir üben ergonomisches Arbeiten. Kurze Wege schonen den Rücken und aufrechte Haltung verhindert Schmerzen.',
        'Am Nachmittag ordnen wir die Wäsche. Stapel beschriften wir sauber. Danach folgt das Falten und Verteilen.',
        'Wir prüfen stromsparendes Verhalten. Geräte laufen nur bei Nutzung. Standby vermeiden wir konsequent.',
        'Nach der Desinfektion lüften wir gründlich. Frische Luft verbessert das Raumklima und trocknet feuchte Flächen.',
        'Wir dokumentieren besondere Flecken. Passende Mittel wählen wir gezielt. Erfolge halten wir schriftlich fest.',
        'Am Ende entsteht ein Kontrollzettel. Er zeigt offene Aufgaben für morgen. Verantwortliche zeichnen ab.',
        'Heute testen wir neue Reinigungspläne. Zeiten und Reihenfolge passen wir an und sammeln Rückmeldungen.',
        'Bei Gefahrstoffen tragen wir Schutz und lesen Hinweise aufmerksam. Lagerorte sichern wir sorgfältig.',
        'Wir sortieren Werkzeuge nach Nutzung. Häufig benötigtes liegt vorn, seltenes höher und staubfrei.',
        'Zum Abschluss prüfen wir alle Räume. Türen schließen, Licht aus und Fenster sichern den Abschluss.'
      ]
    },
    Körperpflege: {
      NOUNS: [
        'der Friseur','die Friseurin','der Salon','der Kunde','die Kundin','die Schere','der Kamm','die Bürste','der Föhn','das Handtuch',
        'das Shampoo','der Conditioner','die Farbe','die Haarmaske','die Pflege','die Haut','das Gesicht','die Creme','die Lotion','die Pinzette',
        'der Spiegel','der Termin','die Reservierung','die Kasse','der Bon','die Uhr','das Waschbecken','der Stuhl','die Umhänge','die Handschuhe',
        'die Hygiene','die Maske','die Desinfektion','das Werkzeug','der Rasierer','die Rasur','die Bartpflege','die Maniküre','die Pediküre','die Feile',
        'die Nagelschere','der Nagellack','der Terminplan','die Beratung','die Farbe','der Schnitt','die Strähnen','die Dauerwelle','die Pflegekur','die Haarspülung',
        'der Haarspray','das Gel','das Wachs','die Haarbürste','die Kopfhaut','die Spitzen','die Länge','die Frisur','die Kosmetik','der Make-up-Pinsel'
      ],
      VERBS: [
        'waschen','schneiden','föhnen','kämmen','bürsten','färben','massieren','pflegen','stylen','rasieren',
        'beraten','vereinbaren','reservieren','planen','reinigen','desinfizieren','auftragen','einwirken','ausspülen','trocknen',
        'kürzen','glätten','locken','fixieren','polieren','feilen','lackieren','anmelden','warten','erklären',
        'vorbereiten','aufräumen','sortieren','einräumen','abwischen','aufschreiben','notieren','prüfen','beachten','schützen'
      ],
      ADJS: ['sauber','glänzend','weich','gesund','trocken','feucht','lang','kurz','hell','dunkel','modern','klassisch','ruhig','freundlich','wichtig','richtig','pünktlich','ordentlich','sicher','dezent'],
      // 80 Sätze Körperpflege (50 gemischt, 15 upper+upper, 15 lower+lower)
      SENTENCES: [
        // Gemischt 1–50
  { tokens:['Im','Salon','wäscht','die','Friseurin','die','Haare.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Bitte','setzen','Sie','sich','auf','den','Stuhl.'], targets:[{i:6,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Kunde','möchte','einen','kurzen','Schnitt.'], targets:[{i:5,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Mara','föhnt','die','Haare','und','stylt','sie.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Heute','färben','wir','Strähnen','in','Blond.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Im','Spiegel','prüft','der','Friseur','die','Frisur.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Bitte','tragen','Sie','Handschuhe','bei','der','Farbe.'], targets:[{i:6,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Beratung','ist','wichtig','und','hilfreich.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Im','Terminplan','stehen','drei','Kunden.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Nach','der','Rasur','desinfizieren','wir','das','Werkzeug.'], targets:[{i:6,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Die','Kosmetik','benutzt','dezente','Farben.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Heute','kommt','die','Kundin','ohne','Termin.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Wir','kämmen','die','Haare','vor','dem','Schnitt.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Friseurin','schneidet','Strähnen','fein','nach.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','rasieren','den','Nacken','vorsichtig.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Kamm','liegt','auf','dem','Tisch.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','massieren','die','Kopfhaut','mit','Creme.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Schere','schneidet','gleichmäßig','weiter.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','glätten','die','Spitzen','behutsam.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Farbe','wirkt','noch','einige','Minuten.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','fixieren','die','Frisur','mit','Spray.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Spiegel','zeigt','den','Schnitt','gut.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','trocknen','die','Haare','sanft','an.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Die','Kundin','wünscht','eine','Beratung.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','notieren','den','Termin','im','Plan.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        { tokens:['Der','Föhn','trocknet','die','Haare','schnell.'], targets:[{i:4,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','kürzen','die','Länge','sauber.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Beratung','betont','Pflege','und','Styling.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','mischen','die','Farbe','frisch','an.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Kunden','fragen','nach','Produkten.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','reinigen','den','Rasierer','vorsichtig.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Kunde','wartet','ruhig','im','Salon.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','polieren','den','Spiegel','vorne.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Frisur','sitzt','gut','heute.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','stylen','die','Spitzen','locker.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Termin','verschiebt','sich','leicht.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','beachten','die','Pflege','nach','der','Behandlung.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Creme','pflegt','Haut','und','Haar.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
        { tokens:['Wir','lackieren','die','Nägel','vorsichtig.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Pinsel','liegt','sauber','bereit.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','kühlen','die','Haut','nach','der','Behandlung.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Lotion','zieht','schnell','ein.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','massieren','den','Nacken','locker.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Kunde','spürt','eine','Entspannung.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','beraten','die','Kundin','freundlich.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Schere','schneidet','präzise','Strähnen.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','pflegen','die','Spitzen','mit','Kur.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Stuhl','dreht','sich','leicht.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','testen','neue','Produkte','vorsichtig.'], targets:[{i:3,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Die','Kosmetik','wirkt','heute','glänzend.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','erklären','den','Ablauf','ruhig.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Der','Salon','öffnet','pünktlich','morgens.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
        { tokens:['Wir','planen','die','Farben','für','morgen.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Die','Strähnen','wirken','gleichmäßig','hell.'], targets:[{i:1,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Wir','schützen','die','Kleidung','mit','Umhang.'], targets:[{i:3,should:'upper'},{i:1,should:'lower'}] },
        // Upper+Upper 51–65
  { tokens:['Die','Frisur','sitzt','locker','heute.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Puder','liegt','fein','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Bürste','gleitet','leicht','durch.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Kamm','liegt','parallel','bereit.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Schere','ruht','kurz','offen.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Spiegel','steht','sauber','gerade.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Farbe','trocknet','gleich','weiter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Clip','hält','fest','oben.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Lotion','duftet','dezent','frisch.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Kunde','bleibt','ruhig','sitzen.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Kosmetik','wirkt','jetzt','intensiv.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Föhn','steht','bereit','heute.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Spitzen','fallen','locker','runter.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Der','Terminplan','füllt','sich','schnell.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
  { tokens:['Die','Beratung','dauert','heute','länger.'], targets:[{i:0,should:'upper'},{i:1,should:'upper'}] },
        // Lower+Lower 66–80
        { tokens:['Wir','arbeiten','heute','ruhig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','testen','wir','vorsichtig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','üben','heute','strukturiert','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','beobachten','wir','sorgfältig','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','protokollieren','heute','exakt','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','planen','wir','übersichtlich','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','korrigieren','heute','ruhig','mehr.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','überprüfen','wir','gründlich','alles.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','sortieren','heute','geordnet','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','wiederholen','wir','ruhig','Techniken.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','mischen','heute','sorgfältig','nach.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','pflegen','wir','systematisch','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','reinigen','heute','gründlich','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Heute','polieren','wir','gleichmäßig','mehr.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] },
        { tokens:['Wir','testen','heute','ruhig','weiter.'], targets:[{i:1,should:'lower'},{i:2,should:'lower'}] }
      ],
      STORIES: [
        'Im Salon beginnt der Tag mit Beratung. Danach waschen wir die Haare und bereiten die Farbe vor. Zum Schluss föhnen wir die Frisur.',
        'Heute üben wir den Kurzhaarschnitt. Wir kämmen die Haare und kürzen die Spitzen. Danach fixieren wir das Styling.',
        'Die Hygiene ist wichtig. Wir desinfizieren Werkzeug und tragen Handschuhe. Der Arbeitsplatz bleibt sauber.',
        'Am Nachmittag kommen mehrere Kunden. Eine Kundin wünscht Strähnen, ein Kunde eine Rasur. Wir planen Zeiten sorgfältig.',
        'Im Kosmetikraum tragen wir eine Maske auf. Die Creme wirkt zehn Minuten ein. Dann spülen wir alles vorsichtig ab.',
        'Die Klasse arbeitet im Übungssalon. Zwei Personen schneiden, andere beraten. Am Ende räumen alle auf.',
        'Vor dem Öffnen richten wir Plätze her. Werkzeug liegt sauber bereit und Handtücher werden gefaltet.',
        'Nach dem Schnitt prüfen wir Übergänge. Kleine Korrekturen verbessern das Gesamtbild deutlich.',
        'Bei Farbberatung erklären wir Nuancen. Kunden sehen Beispiele mit Farbkarten und entscheiden informiert.',
        'Wir testen neue Pflegeprodukte. Wirkung und Verträglichkeit beobachten wir genau und notieren Ergebnisse.',
        'Nach der Pause sortieren wir Kämme. Beschädigte Stücke entsorgen wir sofort, saubere legen wir bereit.',
        'Wir trainieren Rasurtechniken. Sanfte Führung schützt die Haut vor Reizungen und Schnitten.',
        'Während Stoßzeiten planen wir Abläufe. Kurze Wege sparen Zeit und erhalten Qualität.',
        'Beim Styling üben wir Föhntechniken. Rundbürsten geben Volumen und Halt am Ansatz.',
        'Wir dokumentieren Farbmischungen schriftlich. Wiederholungen gelingen sicher und reproduzierbar.',
        'Nach dem Reinigen trocknen Werkzeuge offen. Restfeuchte vermeiden wir konsequent für Hygiene.',
        'Beratungsthemen wiederholen wir regelmäßig. So stärken wir Fachsprache und Auftreten langfristig.',
        'Wir planen Schulungen zu neuen Trends. Teammitglieder teilen Erfahrungen und Techniken.',
        'Vor Feierabend sichern wir Produkte. Schränke schließen und Räume lüften wir gründlich.',
        'Zum Schluss erstellen wir eine Materialliste. Fehlende Artikel bestellen wir zeitnah und strukturiert.'
      ]
    }
  };

  let current = 'Gastronomie';
  const state = { scores:[0,0,0,0], attempts:[0,0,0,0] };
  const updateScoreBar = ()=>{
    for(let i=0;i<4;i++){ document.getElementById('s'+(i+1)).textContent = String(Math.round(state.scores[i])); }
    const total = state.scores.reduce((a,b)=>a+b,0);
    document.getElementById('totalScore').textContent = String(Math.round(total));
    const allDone = state.attempts.every((att, idx)=>{
      const max = [20,20,30,30][idx];
      return att>=2 || Math.round(state.scores[idx]*10)/10 >= max - 1e-9;
    });
    document.getElementById('completeInfo').style.display = allDone ? 'block' : 'none';
    const tip = document.getElementById('reloadTip');
    if(tip) tip.style.display = allDone ? 'block' : 'none';

    const thresholds = (pct)=>{ if(pct<30) return 'danger'; if(pct<50) return 'bad'; if(pct<67) return 'mid'; if(pct<80) return 'ok'; if(pct<90) return 'good'; return 'excellent'; };
    const maxPer = [20,20,30,30];
    for(let i=0;i<4;i++){
      const pill = document.getElementById('pill'+(i+1));
      pill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
      if(state.attempts[i]===0){ pill.classList.add('neutral'); }
      else { const pct = Math.max(0, Math.min(100, (state.scores[i]/maxPer[i])*100)); pill.classList.add(thresholds(pct)); }
    }
    const totalPill = document.getElementById('totalPill');
    totalPill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
    if(!allDone){ totalPill.classList.add('neutral'); }
    else { const pct = Math.max(0, Math.min(100, (total/100)*100)); totalPill.classList.add(thresholds(pct)); }
  };

  function hardDisableButton(selector){
    const btn = document.querySelector(selector);
    if(!btn) return;
    // Nur deaktivieren, ohne Event-Listener zu verlieren.
    btn.disabled = true;
  }

  let a1, a2, a3, a4, a4first;
  function buildWordsDB(){
    const src = DATA[current];
    const o = [];
    const ARTS = ['der','die','das','ein','eine','einen','einem','einer','den','dem','des','mein','meine','dein','deine','sein','seine','ihr','ihre','kein'];
    const PREPS = ['in','auf','unter','über','neben','vor','hinter','zwischen','mit','ohne','für','gegen','durch','wegen','bei','zu','nach','von','seit','um'];
    const ADJS = src.ADJS || [];
    src.NOUNS.forEach(w=>o.push({word:w,pos:'Nomen', expect:'upper', base: stripPunct(w.replace(/^(der|die|das|den|dem|des|ein|eine|einen|einem|einer)\\s+/,'')).toLowerCase()}));
    (src.VERBS||[]).forEach(w=>o.push({word:w,pos:'Verb', expect:'lower', base: w.toLowerCase()}));
    PREPS.forEach(w=>o.push({word:w,pos:'Präposition', expect:'lower', base: w.toLowerCase()}));
    ADJS.forEach(w=>o.push({word:w,pos:'Adjektiv', expect:'lower', base: w.toLowerCase()}));
    ARTS.forEach(w=>o.push({word:w,pos:'Artikel', expect:'lower', base: w.toLowerCase()}));
    const seen = {};
    o.forEach(it=>{ seen[it.base] = seen[it.base] || new Set(); seen[it.base].add(it.expect); });
    const filtered = o.filter(it=> seen[it.base].size === 1);
    return filtered;
  }

  function buildSentencesDB(){ return DATA[current].SENTENCES.slice(); }
  function buildStoriesDB(){ return DATA[current].STORIES.map(t=>({correct:t})); }

  const computeTwoAttemptPoints = (totalItems, correctFirst, correctSecondOnly, maxPoints=20)=>{
    const frac = (correctFirst + 0.5*correctSecondOnly) / Math.max(1,totalItems);
    return Math.max(0, Math.min(maxPoints, frac*maxPoints));
  };

  function storyToTokens(correctText){
    const raw = tokenize(correctText);
    return raw.map(tok=>{
      if(isWord(tok)){
        const should = /^[A-ZÄÖÜ]/.test(tok);
        return {text: tok, isWord:true, shouldCap: should};
      }else{
        return {text: tok, isWord:false, shouldCap:false};
      }
    });
  }

  // Aufgabe 1
  function initTask1(){
    const wordsDB = buildWordsDB();
    a1 = { items: pickN(wordsDB, 20).map((it,idx)=>({id:'w'+idx, ...it})), firstCorrect:new Set() };
    const pool = $('#pool1'); pool.innerHTML='';
    $('#binUpper').innerHTML=''; $('#binLower').innerHTML='';
    a1.items.forEach(it=>{
      const chip = document.createElement('div');
      chip.className='chip'; chip.draggable=true; chip.id=it.id;
      const base = it.word.replace(/^der |^die |^das |^den |^dem |^des |^ein |^eine |^einen |^einem |^einer /,'');
      chip.textContent = deLower(base);
      chip.dataset.expect = it.expect;
      chip.title = `${it.pos}`;
      chip.addEventListener('dragstart', ev=>{ ev.dataTransfer.setData('text/plain', it.id); });
      pool.appendChild(chip);
    });
    [$('#pool1'), $('#binUpper'), $('#binLower')].forEach(bin=>{
      bin.addEventListener('dragover', ev=>ev.preventDefault());
      bin.addEventListener('drop', ev=>{
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        const el = document.getElementById(id);
        if(!el) return;
        bin.appendChild(el);
        updateTask1CheckEnabled();
      });
    });
    $('#res1').textContent='';
    $('#check1').disabled=true;
    $('#retry1').disabled=true;
    updateTask1CheckEnabled();
  }
  function updateTask1CheckEnabled(){
    const remaining = $('#pool1').querySelectorAll('.chip').length;
    const firstAttemptAvailable = state.attempts[0] === 0;
    $('#check1').disabled = !firstAttemptAvailable || remaining>0;
  }
  function checkTask1(isRetry=false){
    const total = a1.items.length;
    let newlyCorrect = 0;
    const pool = $('#pool1');
    a1.items.forEach(it=>{
      const el = document.getElementById(it.id);
      const parent = el?.parentElement;
      const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
      const ok = (placedZone === it.expect);
      if(!isRetry){ if(ok) a1.firstCorrect.add(it.id); }
      else { if(ok && !a1.firstCorrect.has(it.id)) newlyCorrect++; }
      if(ok){ el.style.boxShadow='inset 0 0 0 2px #a5d6a7'; el.classList.add('locked'); el.draggable=false; }
      else { el.style.boxShadow=''; pool.appendChild(el); }
    });
    let points;
    if(!isRetry){
      points = computeTwoAttemptPoints(total, a1.firstCorrect.size, 0, 20);
      $('#res1').innerHTML = `Richtig im 1. Versuch: ${a1.firstCorrect.size}/${total} → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=false; hardDisableButton('#check1');
    } else {
      points = computeTwoAttemptPoints(total, a1.firstCorrect.size, newlyCorrect, 20);
      $('#res1').innerHTML = `Nach 2. Versuch: +${(newlyCorrect*0.5*20/total).toFixed(1)} Punkte → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=true; hardDisableButton('#check1'); hardDisableButton('#retry1');
      a1.items.forEach(it=>{
        const el = document.getElementById(it.id);
        const parent = el?.parentElement;
        const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
        const ok = (placedZone === it.expect);
        if(!ok){
          const targetBin = it.expect === 'upper' ? $('#binUpper') : $('#binLower');
          targetBin.appendChild(el);
          el.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
          el.style.background = '#fff7f7';
        } else {
          el.style.boxShadow = 'inset 0 0 0 2px #a5d6a7';
        }
        el.classList.add('locked'); el.draggable=false;
      });
    }
    state.scores[0] = points; state.attempts[0] = isRetry?2:1; updateScoreBar(); updateTask1CheckEnabled();
  }

  // Aufgabe 2
  function renderTask2(){
    a2 = { data: pickN(buildSentencesDB(), 10), firstCorrect:new Set() };
    const container = $('#sentences'); container.innerHTML='';
    a2.data.forEach((s, si)=>{
      const card = document.createElement('div'); card.className='card sentence'; card.dataset.si = si;
      const line = document.createElement('div');
      s.tokens.forEach((tok, i)=>{
        const tinfo = s.targets.find(t=>t.i===i);
        if(tinfo){
          const m = /^(.+?)([.,;:!?]+)?$/.exec(tok) || [];
          const base = m[1] || tok; const punc = m[2] || '';
          const sp = document.createElement('span');
          sp.className='smallcaps pending';
          sp.textContent = deLower(base);
          sp.dataset.si = si; sp.dataset.ti = i; sp.dataset.correct = tinfo.should; sp.dataset.choice = '';
          sp.addEventListener('click', onPopup);
          line.appendChild(sp);
          if(punc) line.append(punc);
        }else{ line.append(tok); }
        if(i < s.tokens.length-1) line.append(' ');
      });
      card.appendChild(line); container.appendChild(card);
    });
    $('#res2').textContent='';
    $('#check2').disabled=true; $('#retry2').disabled=true;
    updateTask2CheckEnabled();
  }
  function updateTask2CheckEnabled(){
    const all = Array.from(document.querySelectorAll('#sentences .smallcaps'));
    const decided = all.filter(sp=> (sp.dataset.choice||'') !== '');
    const firstAttemptAvailable = state.attempts[1] === 0;
    $('#check2').disabled = !firstAttemptAvailable || decided.length !== all.length || all.length===0;
  }
  const popup = $('#popup2');
  function onPopup(ev){
    const target = ev.currentTarget;
    const rect = target.getBoundingClientRect();
    popup.style.left = Math.max(8, rect.left + window.scrollX) + 'px';
    popup.style.top = (rect.top + window.scrollY - 42) + 'px';
    popup.style.display='block';
    popup.dataset.targetSi = target.dataset.si;
    popup.dataset.targetTi = target.dataset.ti;
  }
  document.addEventListener('click', (e)=>{ if(!popup.contains(e.target) && !e.target.classList.contains('smallcaps')){ popup.style.display='none'; } });
  popup.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const si = Number(popup.dataset.targetSi);
      const ti = Number(popup.dataset.targetTi);
      const choice = btn.dataset.choice;
      const span = document.querySelector(`#task2 .smallcaps[data-si="${si}"][data-ti="${ti}"]`);
      if(span){
        span.dataset.choice = choice;
        const wordLower = deLower(span.textContent);
        span.style.fontWeight = '700';
        span.textContent = (choice==='upper') ? capFirst(wordLower) : wordLower;
        span.classList.remove('pending');
      }
      popup.style.display='none';
      updateTask2CheckEnabled();
    });
  });
  function checkTask2(isRetry=false){
    let totalTargets=0, newly=0;
    const wrongSentences = new Set();
    a2.data.forEach((s, si)=>{
      let sentenceOK = true;
      s.targets.forEach(t=>{
        totalTargets++;
        const span = document.querySelector(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
        const choice = span?.dataset.choice || '';
        const ok = (choice === t.should);
        if(!ok) sentenceOK = false;
        if(!isRetry){ if(ok){ a2.firstCorrect.add(`${si}-${t.i}`); } }
        else { if(ok && !a2.firstCorrect.has(`${si}-${t.i}`)) newly++; }
      });
      const card = document.querySelector(`#task2 .sentence[data-si="${si}"]`);
      card.classList.toggle('error', !sentenceOK);
      if(!sentenceOK) wrongSentences.add(si);
    });
    const pts = computeTwoAttemptPoints(totalTargets, a2.firstCorrect.size, newly, 20);
    if(!isRetry){
      document.getElementById('res2').innerHTML = `Sätze mit Fehlern: ${wrongSentences.size} von ${a2.data.length} → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      wrongSentences.forEach(si=>{
        const spans = Array.from(document.querySelectorAll(`#task2 .smallcaps[data-si="${si}"]`));
        spans.forEach(sp=>{
          sp.dataset.choice = '';
          sp.style.fontWeight = '400';
          const wordLower = deLower(sp.textContent);
          sp.textContent = wordLower;
          sp.classList.add('pending');
        });
      });
      document.getElementById('check2').disabled=true; document.getElementById('retry2').disabled=false; hardDisableButton('#check2');
    }else{
      document.getElementById('res2').innerHTML = `Nach 2. Versuch: korrigiert +${(newly*0.5*20/totalTargets).toFixed(1)} Punkte → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      document.getElementById('check2').disabled=true; document.getElementById('retry2').disabled=true; hardDisableButton('#check2'); hardDisableButton('#retry2');
      a2.data.forEach((s, si)=>{
        s.targets.forEach(t=>{
          const sp = document.querySelector(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
          const ok = (sp?.dataset.choice === t.should);
          if(!ok && sp){
            const base = deLower(sp.textContent);
            sp.textContent = (t.should==='upper') ? capFirst(base) : base;
            sp.style.fontWeight = '700';
            sp.classList.remove('pending');
            sp.style.background = '#fff7f7';
            sp.style.borderBottomColor = '#ef9a9a';
            sp.style.color = '#c62828';
          }
        });
      });
    }
    state.scores[1] = pts; state.attempts[1] = isRetry?2:1; updateScoreBar();
  }

  // Aufgabe 3
  function initTask3(){
    const storiesDB = buildStoriesDB();
    const idx = rnd(storiesDB.length);
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
    a3 = { idx, tokens: toks, userCap: toks.map(t=>false), firstCorrect: toks.map(()=>false), clicked: toks.map(()=>false), firstUserCap: toks.map(()=>false), scoreUnitsFirst:0, maxUnits: toks.filter(t=>t.isWord && t.shouldCap).length };
    const host = $('#story3'); host.innerHTML='';
    toks.forEach((t, i)=>{
      const span = document.createElement('span');
      span.className = 'tok';
      span.dataset.i = i;
      if(t.isWord){
        span.textContent = deLower(t.text);
        span.addEventListener('click', ()=>{
          if(span.classList.contains('locked')) return;
          a3.userCap[i] = !a3.userCap[i];
          a3.clicked[i] = true;
          span.classList.toggle('cap', a3.userCap[i]);
          const base = deLower(t.text);
          span.textContent = a3.userCap[i] ? capFirst(base) : base;
        });
      }else{
        span.textContent = t.text;
        span.classList.add('locked');
      }
      host.appendChild(span);
      if(t.isWord) host.append(' ');
    });
    $('#res3').textContent='';
    $('#check3').disabled=false; $('#retry3').disabled=true;
  }
  function checkTask3(isRetry=false){
    const words = a3.tokens.map((t,i)=>({t,i})).filter(x=>x.t.isWord);
    const mustCap = words.filter(x=>x.t.shouldCap).map(x=>x.i);
    let scoreUnits = 0; let newlyFixedMustCap = 0;
    words.forEach(({t,i})=>{
      const isCap = !!a3.userCap[i];
      if(t.shouldCap && isCap) scoreUnits += 1;
      if(!t.shouldCap && isCap) scoreUnits -= 1;
      if(isRetry){ if(t.shouldCap && isCap && !a3.firstUserCap[i]) newlyFixedMustCap++; }
      else { a3.firstCorrect[i] = (isCap === t.shouldCap); a3.firstUserCap[i] = isCap; }
      const span = document.querySelector(`#story3 .tok[data-i="${i}"]`);
      span.classList.remove('correct');
      if(!isRetry){
        if(t.shouldCap && isCap && a3.clicked[i]){ span.classList.add('correct'); span.classList.add('locked'); }
        else {
          const base = deLower(t.text);
          a3.userCap[i] = false;
          span.textContent = base;
          span.classList.remove('cap');
        }
      }
    });
    const maxUnits = mustCap.length;
    let scoreUnitsFinal = !isRetry ? scoreUnits : (a3.scoreUnitsFirst + 0.5 * newlyFixedMustCap);
    if(!isRetry){ a3.scoreUnitsFirst = scoreUnits; }
    const norm = Math.max(0, Math.min(maxUnits, scoreUnitsFinal));
    const pts = Math.round((norm / Math.max(1, maxUnits)) * 30);
    if(!isRetry){
      const additionally = Math.max(0, mustCap.length - mustCap.filter(i=>a3.userCap[i]).length);
      document.getElementById('res3').innerHTML = `Bewertung im 1. Versuch: ${norm}/${maxUnits} → <span class="ok">${pts} Punkte</span> <span class="warn">(zusätzlich groß zu schreiben: ${additionally})</span>`;
      document.getElementById('check3').disabled=true; document.getElementById('retry3').disabled=false;
    }else{
      words.forEach(({t,i})=>{
        const span = document.querySelector(`#story3 .tok[data-i="${i}"]`);
        const should = t.shouldCap;
        const base = deLower(t.text);
        const isCap = !!a3.userCap[i];
        span.textContent = should ? capFirst(base) : base;
        span.classList.remove('correct','cap');
        span.classList.add('locked');
        if(isCap !== should){
          span.style.background = '#fff7f7';
          span.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
        }
      });
      document.getElementById('res3').innerHTML = `Nach 2. Versuch: aktualisiert → <span class="ok">${pts} Punkte</span>`;
      document.getElementById('check3').disabled=true; document.getElementById('retry3').disabled=true; hardDisableButton('#check3'); hardDisableButton('#retry3');
    }
    state.scores[2] = pts; state.attempts[2] = isRetry?2:1; updateScoreBar();
  }

  // Aufgabe 4
  function initTask4(){
    const storiesDB = buildStoriesDB();
    const options = storiesDB.map((_,i)=>i).filter(i=>i!==a3?.idx);
    const idx = options.length ? options[rnd(options.length)] : 0;
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
    a4 = { idx, tokens: toks, lowerSrc: story.toLocaleLowerCase('de-DE') };
    document.getElementById('story4src').textContent = a4.lowerSrc;
    document.getElementById('story4txt').value = '';
    document.getElementById('story4feedback').innerHTML='';
    document.getElementById('res4').textContent='';
    document.getElementById('check4').disabled=true; document.getElementById('retry4').disabled=true;
    document.getElementById('c4').textContent='';
  }
  function analyzeUserVsStory(userText, storyTokens){
    const userTokens = storyToTokens(userText);
    const storyWords = storyTokens.filter(t=>t.isWord);
    const total = storyWords.length;
    const result = [];
    let correctFirst=0, typos=0;
    let wi = 0;
    for(const tok of userTokens){
      if(tok.isWord){
        let capOK=false, spellOK=false;
        if(wi < storyWords.length){
          const exp = storyWords[wi];
          const expShouldCap = exp.shouldCap;
          const gotIsCap = /^[A-ZÄÖÜ]/.test(tok.text);
          const baseExp = deLower(exp.text);
          const baseGot = deLower(tok.text);
          capOK = (expShouldCap === gotIsCap);
          spellOK = (baseExp === baseGot);
          if(capOK) correctFirst++;
          if(!spellOK) typos++;
        }
        result.push({type:'word', text: tok.text, capOK, spellOK});
        wi++;
      } else if(/[.,;:!?]/.test(tok.text)){
        result.push({type:'punct', text: tok.text});
      }
    }
    const missing = Math.max(0, storyWords.length - wi);
    if(missing>0){
      for(let k=wi; k<storyWords.length; k++){
        result.push({type:'missing', expected: deLower(storyWords[k].text)});
      }
    }
    const pts = (correctFirst/Math.max(1,total))*30;
    return { items: result, total, correctCount: correctFirst, typos, missing, points: Math.round(Math.max(0, Math.min(30, pts))) };
  }
  function renderFeedback(items, showCap=true){
    const style = 'padding:2px 4px; border-radius:6px; margin-right:4px; display:inline-block';
    const out = [];
    for(const x of items){
      if(x.type==='punct'){
        const last = out.length ? out.pop() : '';
        const merged = (last || '') + `${x.text}`;
        out.push(merged);
        continue;
      }
      if(x.type==='missing'){
        out.push(`<span class="mark-typo" style="${style}">[${x.expected}]</span>`);
        continue;
      }
      let cls = x.capOK ? 'correct' : 'mark-cap';
      if(!showCap){ cls = x.spellOK ? '' : 'mark-typo'; }
      else { if(!x.spellOK) cls = 'mark-typo'; }
      const token = cls ? `<span class="${cls}" style="${style}">${x.text}</span>` : `${x.text}`;
      out.push(token);
    }
    return out.join(' ');
  }
  function checkTask4(isRetry=false){
    const text = document.getElementById('story4txt').value;
    const analysis = analyzeUserVsStory(text, a4.tokens);
    if(!isRetry){
      a4first = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      document.getElementById('story4feedback').innerHTML = renderFeedback(analysis.items, false);
      const wordItems = analysis.items.filter(x=>x.type==='word');
      let wrongAsUpper=0, wrongAsLower=0;
      for(let i=0;i<wordItems.length;i++){
        const shouldCap = a4.tokens.filter(t=>t.isWord)[i]?.shouldCap;
        const gotIsCap = /^[A-ZÄÖÜ]/.test(wordItems[i].text);
        if(shouldCap && !gotIsCap) wrongAsLower++;
        if(!shouldCap && gotIsCap) wrongAsUpper++;
      }
      document.getElementById('res4').innerHTML = `Richtig (Groß/Klein) im 1. Versuch: ${analysis.correctCount}/${analysis.total} → <span class="ok">${Math.round(analysis.points)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span><br/><div class="desc">Wörter, die du groß geschrieben hast, die du aber klein schreiben musst: ${wrongAsUpper}<br/>Wörter, die du klein geschrieben hast, die du aber groß schreiben musst: ${wrongAsLower}</div>`;
      state.scores[3] = analysis.points;
      document.getElementById('check4').disabled=true; document.getElementById('retry4').disabled=false; state.attempts[3] = 1; hardDisableButton('#check4');
    }else{
      const now = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      let newly=0; for(let i=0;i<now.length;i++){ if(now[i] && a4first && !a4first[i]) newly++; }
      const pts = computeTwoAttemptPoints(analysis.total, (a4first||[]).filter(Boolean).length, newly, 30);
      document.getElementById('story4feedback').innerHTML = renderFeedback(analysis.items, true);
      // Fehlerstatistik auch im 2. Versuch ausgeben
      const wordItems = analysis.items.filter(x=>x.type==='word');
      let wrongAsUpper=0, wrongAsLower=0;
      for(let i=0;i<wordItems.length;i++){
        const shouldCap = a4.tokens.filter(t=>t.isWord)[i]?.shouldCap;
        const gotIsCap = /^[A-ZÄÖÜ]/.test(wordItems[i].text);
        if(shouldCap && !gotIsCap) wrongAsLower++;
        if(!shouldCap && gotIsCap) wrongAsUpper++;
      }
      document.getElementById('res4').innerHTML = `Nach 2. Versuch: +${Math.round(newly*0.5*30/analysis.total)} Punkte → <span class="ok">${Math.round(pts)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span><br/><div class="desc">Wörter, die du groß geschrieben hast, die du aber klein schreiben musst: ${wrongAsUpper}<br/>Wörter, die du klein geschrieben hast, die du aber groß schreiben musst: ${wrongAsLower}</div>`;
      hardDisableButton('#check4'); hardDisableButton('#retry4');
      state.scores[3] = pts; document.getElementById('check4').disabled=true; document.getElementById('retry4').disabled=true; state.attempts[3] = 2;
    }
    updateScoreBar();
  }

  function initAll(){
    state.scores=[0,0,0,0]; state.attempts=[0,0,0,0]; updateScoreBar();
    initTask1(); renderTask2(); initTask3(); initTask4();
    // Nach einem Neustart sicherstellen, dass alle Buttons frische Event-Listener besitzen
    bindAllButtons();
    const ta = document.getElementById('story4txt');
    ta.oninput = ()=>{
      const v = ta.value;
      const w = v.trim().split(/\s+/).filter(Boolean).length;
      document.getElementById('c4').textContent = `Wörter: ${w}`;
      if(state.attempts[3] === 0){ document.getElementById('check4').disabled = !(v.trim().length>0 && /\s/.test(v)); }
      else { document.getElementById('check4').disabled = true; }
    };
  }

  // Sorgt dafür, dass alle Check-/Retry-Buttons definierte, frische Handler haben
  function bindAllButtons(){
    const rebind = (id, fn)=>{
      const oldBtn = document.getElementById(id);
      if(!oldBtn) return;
      const clone = oldBtn.cloneNode(true);
      // Status (disabled, Klassen, Text) werden mit geklont
      oldBtn.replaceWith(clone);
      clone.addEventListener('click', fn);
    };
    rebind('check1', ()=>checkTask1(false));
    rebind('retry1', ()=>checkTask1(true));
    rebind('check2', ()=>checkTask2(false));
    rebind('retry2', ()=>checkTask2(true));
    rebind('check3', ()=>checkTask3(false));
    rebind('retry3', ()=>checkTask3(true));
    rebind('check4', ()=>checkTask4(false));
    rebind('retry4', ()=>checkTask4(true));
  }

  document.getElementById('check1').addEventListener('click', ()=>checkTask1(false));
  document.getElementById('retry1').addEventListener('click', ()=>checkTask1(true));
  document.getElementById('check2').addEventListener('click', ()=>checkTask2(false));
  document.getElementById('retry2').addEventListener('click', ()=>checkTask2(true));
  document.getElementById('check3').addEventListener('click', ()=>checkTask3(false));
  document.getElementById('retry3').addEventListener('click', ()=>checkTask3(true));
  document.getElementById('check4').addEventListener('click', ()=>checkTask4(false));
  document.getElementById('retry4').addEventListener('click', ()=>checkTask4(true));

  const sel = document.getElementById('fach');
  document.getElementById('start').addEventListener('click', ()=>{
    current = sel.value;
    initAll();
    window.scrollTo({top:0, behavior:'smooth'});
  });

  current = sel.value;
  initAll();

  ['copy','cut','contextmenu','selectstart','dragstart'].forEach(evt=>{
    document.getElementById('story4src').addEventListener(evt, e=>{ e.preventDefault(); return false; });
  });
})();
</script>
</body>
</html>