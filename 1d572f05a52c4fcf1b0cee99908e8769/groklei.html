<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Groß- und Kleinschreibung – A2 Übungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --ink:#152038;
      --muted:#5b6475;
      --accent:#2962ff;
      --ok:#2e7d32;
      --warn:#ef6c00;
      --bad:#c62828;
      --chip:#eef2ff;
      --drop:#e8f5e9;
      --drop2:#fff3e0;
      --shadow:0 6px 20px rgba(0,0,0,.08);
      --border:#e3e6ef;
      --cap:#0d47a1;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink); background:var(--bg);
    }
    header{
      position:sticky; top:0; z-index:5; background:linear-gradient(180deg,#ffffff 0%, #fafbff 100%);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px 20px;}
    h1{font-size:1.4rem; margin:0 0 6px 0;}
    .scorebar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted);
      font-size:.95rem;
    }
    .scorebar .pill{
      background:var(--card); border:1px solid var(--border); border-radius:100px; padding:6px 10px;
    }
    /* Ampel-Färbung (IHK-Schlüssel in 6 Stufen) */
    .pill.neutral{ background:var(--card); color:inherit; border-color:var(--border) }
    .pill.danger{ background:#fdecea; color:#b71c1c; border-color:#f5c6cb }
  /* <50% soll ein Rotton sein */
  .pill.bad{ background:#ffebee; color:#c62828; border-color:#ffcdd2 }
    .pill.mid{ background:#fff9c4; color:#7a6e00; border-color:#fff59d }
    .pill.ok{ background:#e8f5e9; color:#1b5e20; border-color:#c8e6c9 }
    .pill.good{ background:#d0f0d7; color:#1b5e20; border-color:#b2dfbd }
    .pill.excellent{ background:#c8e6c9; color:#1b5e20; border-color:#a5d6a7 }
    main .section{
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px;
      margin:16px auto; box-shadow:var(--shadow);
    }
    h2{font-size:1.2rem; margin:0 0 8px 0;}
    .desc{color:var(--muted); margin-bottom:12px;}
    .area{display:grid; gap:14px;}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      background:var(--chip); border:1px solid #d6dcff; color:#1b2a6f;
      padding:8px 10px; border-radius:999px; cursor:grab; user-select:none;
      transition:.15s transform ease;
    }
    .chip:active{transform:scale(.97); cursor:grabbing;}
    .bins{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .bin{
      min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fafbff;
    }
    .bin-title{font-weight:600; margin-bottom:6px;}
    .bin.gr{background:var(--drop)}
    .bin.kl{background:var(--drop2)}
    .pool{min-height:84px; border:2px dashed var(--border); border-radius:12px; padding:10px; background:#fff;}
    .btnbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px;}
    button{
      appearance:none; border:none; background:var(--accent); color:#fff; padding:10px 14px; border-radius:10px;
      cursor:pointer; font-weight:600; box-shadow:0 2px 10px rgba(41,98,255,.25);
    }
    button.secondary{background:#e8ebf8; color:#1b2a6f; box-shadow:none}
    button.ghost{background:transparent; color:var(--muted); box-shadow:none}
    button:disabled{opacity:.5; cursor:not-allowed}
    .hint{color:var(--muted); font-size:1.0rem}
    .smallcaps{font-variant:small-caps; letter-spacing:.03em; color:var(--cap); border-bottom:1px dotted #90caf9; cursor:pointer;}
  .smallcaps.pending{ background:#ffe0b2; color:#8a4b00; padding:0 2px; border-radius:4px }
    .popup{
      position:absolute; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);
      padding:6px; display:none; z-index:10;
    }
    .popup button{padding:6px 10px; margin:2px; box-shadow:none}
    .sentence{line-height:1.7}
    .card{border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff}
    .locked{opacity:.65; pointer-events:none}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1b2a6f; font-size:.85rem; margin-left:6px}
    .result{font-weight:700}
    .texttokens{line-height:1.9}
    .tok{padding:2px 2px; border-radius:4px; cursor:pointer}
    .tok.cap{background:#e3f2fd; border:1px solid #bbdefb}
    .tok.correct{box-shadow:inset 0 0 0 2px #a5d6a7}
    /* .tok.wrong removed for Aufgabe 3 */
    .preview{border:1px dashed var(--border); border-radius:10px; padding:10px; background:#fcfcff}
  /* Ursprungstext größer und nicht kopierbar */
  #story4src{ font-size:1.2rem; user-select:none }
    .mark-cap{background:#fff3cd}
    .mark-typo{background:#ffebee}
  textarea{width:100%; min-height:140px; resize:vertical; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:1.4rem;}
    .counter{color:var(--muted); font-size:.92rem}
    .badge{display:inline-block; padding:2px 8px; border-radius:12px; background:#f0f4ff; color:#1b2a6f; font-size:.82rem; margin-left:6px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    /* Sätze mit Fehlern visuell markieren */
    .sentence.error{border-color:#ef9a9a; background:#fff7f7}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Übungen: Groß- und Kleinschreibung</h1>
  </div>
</header>

<main class="wrap">

  <section class="section" id="task1">
    <h2>Aufgabe 1 – Wörter zu „groß“ oder „klein“ ziehen <span class="badge">20 Punkte</span></h2>
    <div class="desc">
      Aufgabe: „Wie wird dieses Wort im Satz (nicht am Satzanfang) geschrieben?“ Ziehe jedes Wort in das richtige Feld.
    </div>
    <div class="area">
      <div class="row">
        <div class="card" style="flex:1">
          <div class="bin-title">Nicht sortiert</div>
          <div id="pool1" class="pool" data-accept="any"></div>
        </div>
      </div>
      <div class="bins">
        <div class="card">
          <div class="bin-title">groß (Nomen, Eigennamen)</div>
          <div id="binUpper" class="bin gr" data-accept="upper"></div>
        </div>
        <div class="card">
          <div class="bin-title">klein (Verben, Adjektive, Präpositionen, Artikel)</div>
          <div id="binLower" class="bin kl" data-accept="lower"></div>
        </div>
      </div>
      <div class="btnbar">
        <button id="check1" disabled>Prüfen – Versuch 1</button>
        <button id="retry1" class="secondary" disabled>Zweiter Versuch</button>
        <span class="hint">Max. 20 Punkte. Im 2. Versuch halbe Punkte je nachträglich richtigem Wort.</span>
      </div>
      <div class="result" id="res1"></div>
    </div>
  </section>

  <section class="section" id="task2">
    <h2>Aufgabe 2 – Wähle „groß/klein“ in Sätzen <span class="badge">20 Punkte</span></h2>
    <div class="desc">
      In jedem Satz sind zwei Wörter markiert. Klicke sie an und wähle, ob sie groß oder klein geschrieben werden.
    </div>
    <div id="sentences" class="area"></div>
    <div class="btnbar">
      <button id="check2" disabled>Prüfen – Versuch 1</button>
      <button id="retry2" class="secondary" disabled>Zweiter Versuch</button>
      <span class="hint">Max. 20 Punkte. Im 2. Versuch halbe Punktzahl.</span>
    </div>
    <div class="popup" id="popup2">
      <button data-choice="upper">groß</button>
      <button data-choice="lower">klein</button>
    </div>
    <div class="result" id="res2"></div>
  </section>

  <section class="section" id="task3">
    <h2>Aufgabe 3 – Klicke die Wörter groß <span class="badge">30 Punkte</span></h2>
    <div class="desc">
      Alle Wörter sind klein geschrieben. Klicke Wörter, die groß geschrieben werden müssen (Satzanfänge, Nomen, Namen, Länder/ Städte).<br><br>
    <div id="story3" class="card texttokens"></div>
    <div class="btnbar">
      <button id="check3">Prüfen – Versuch 1</button>
      <button id="retry3" class="secondary" disabled>Zweiter Versuch</button>
    </div>
    <div class="result" id="res3"></div>
  </section>

  <section class="section" id="task4">
    <h2>Aufgabe 4 – Richtig abschreiben <span class="badge">30 Punkte</span></h2>
    <div class="desc">
  Schreibe die klein geschriebene Geschichte in das Textfeld ab – mit korrekter Groß-/Kleinschreibung.<br>
    <b>Bitte vergesse beim Abschreiben keine Wörter. Dann funktioniert die Korrektur nicht!</b><br>
    (Schreibfehler werden markiert, zählen aber nicht zur Punktzahl.)
    </div>
    <div id="story4src" class="preview mono"></div>
    <div class="row">
      <textarea id="story4txt" spellcheck="false" placeholder="Hier korrekt abschreiben …"></textarea>
    </div>
    <div class="btnbar">
      <button id="check4" disabled>Prüfen – Versuch 1</button>
      <button id="retry4" class="secondary" disabled>Zweiter Versuch</button>
      <span class="counter" id="c4"></span>
    </div>
    <div class="preview" id="story4feedback"></div>
    <div class="result" id="res4"></div>
  </section>

</main>

<!-- Gesamtauswertung unten -->
<section class="wrap section" id="summary">
  <h2>Punkte</h2>
  <div class="scorebar" id="scorebarBottom">
    <div class="pill" id="totalPill">Gesamt: <span id="totalScore">0</span> / 100</div>
    <div class="pill" id="pill1">A1: <span id="s1">0</span>/20</div>
    <div class="pill" id="pill2">A2: <span id="s2">0</span>/20</div>
    <div class="pill" id="pill3">A3: <span id="s3">0</span>/30</div>
    <div class="pill" id="pill4">A4: <span id="s4">0</span>/30</div>
  </div>
  <div id="completeInfo" class="result ok" style="display:none; margin-top:8px">Alle Aufgaben abgeschlossen: Jede Aufgabe ist entweder vollständig richtig oder nach zwei Versuchen beendet.</div>
  <div id="reloadTip" class="desc" style="display:none">Tipp: Du kannst die Seite neu laden, um andere zufällige Inhalte zu erhalten.</div>
  <br/>
</section>

<footer class="wrap" style="color:var(--muted); padding-bottom:40px">
  
</footer>

<script>
(function(){
  const rnd = (n)=>Math.floor(Math.random()*n);
  const shuffle = (arr)=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  const pickN = (arr, n)=>shuffle(arr.slice()).slice(0,n);
  const deLower = s => s.toLocaleLowerCase('de-DE');
  const deUpper = s => s.toLocaleUpperCase('de-DE');
  const capFirst = s => s.replace(/^([a-zäöüß])/i, (m)=>m.toLocaleUpperCase('de-DE'));
  const isWord = (t)=>/^[A-Za-zÄÖÜäöüß\-]+$/.test(t);
  const stripPunct = (t)=>t.replace(/^[^\p{L}]+|[^\p{L}]+$/gu,'');
  const tokenize = (text)=>{
    const parts = [];
    let m, re = /([A-Za-zÄÖÜäöüß\-]+|[0-9]+|[^\sA-Za-zÄÖÜäöüß0-9\-]+)/g;
    let last = 0;
    while((m=re.exec(text))!==null){
      const idx = m.index;
      if(idx>last){
        const gap = text.slice(last, idx);
      }
      parts.push(m[0]);
      last = idx + m[0].length;
    }
    return parts;
  };

  // =========================
  // Inhalte (leicht editierbar)
  // =========================
  // Aufgabe 1: Wortlisten
  const NOUNS = [
    'der Arzt','die Ärztin','das Krankenhaus','die Praxis','die Schule','die Klasse','der Kurs','die Prüfung','die Aufgabe','die Antwort',
    'die Frage','der Freund','die Freundin','die Familie','der Vater','die Mutter','der Bruder','die Schwester','das Kind','die Kinder',
    'die Wohnung','das Zimmer','die Küche','das Bad','der Balkon','der Vertrag','die Rechnung','der Termin','die Zeit','der Bahnhof',
    'der Bus','die Straßenbahn','die U-Bahn','der Zug','das Auto','der Führerschein','die Stadt','das Dorf','das Land','die Sprache',
    'der Brief','die E-Mail','das Handy','der Computer','die Arbeit','der Beruf','der Kollege','die Kollegin','der Chef','die Chefin',
    'das Büro','die Firma','der Supermarkt','der Markt','das Geld','das Konto','die Bank','der Euro','der Cent',
    'der Preis','der Rabatt','der Einkauf','der Haushalt','der Kühlschrank','der Herd','der Tisch','der Stuhl','das Bett','die Lampe',
    'das Fenster','die Tür','der Schlüssel','der Garten','der Park','der Weg','die Straße','die Kreuzung','die Ampel','die Anmeldung',
    'das Formular','das Beispiel','der Fehler','die Hilfe','die Gesundheit','die Krankheit','der Urlaub','der Plan','die Idee','die Nachricht'
  ];
  const VERBS = [
    'kommen','gehen','fahren','arbeiten','backen','sprechen','schreiben','lesen','schlafen','schneiden',
    'trinken','wohnen','kaufen','verkaufen','brauchen','suchen','finden','nehmen','geben','bringen',
    'bleiben','beginnen','enden','besuchen','anrufen','einkaufen','aufstehen','aufräumen','kochen','putzen',
    'öffnen','schließen','zahlen','bezahlen','bestellen','reservieren','warten','helfen','erklären','verstehen',
    'üben','fragen','antworten','vergleichen','reisen','schwimmen','laufen','wandern','feiern','planen'
  ];
  const ADJS = [
    'groß','klein','neu','alt','teuer','billig','laut','leise','schnell','langsam',
    'freundlich','nett','wichtig','richtig','falsch','müde','krank','gesund','frei','sauber'
  ];
  const PREPS = [
    'in','auf','unter','über','neben','vor','hinter','zwischen','mit','ohne',
    'für','gegen','durch','wegen','bei','zu','nach','von','seit','um'
  ];
  const ARTS = [
    'der','die','das','ein','eine','einen','einem','einer','den','dem',
    'des','mein','meine','dein','deine','sein','seine','ihr','ihre','kein'
  ];

  // Aufgabe 2: Sätze – fester Pool (siehe Funktion unten)

  // Buttons nach 2. Versuch hart deaktivieren (Listener entfernen)
  function hardDisableButton(selector){
    const btn = document.querySelector(selector);
    if(!btn) return;
    const clone = btn.cloneNode(true);
    clone.disabled = true;
    btn.replaceWith(clone);
  }

  // Score state
  const state = {
    scores:[0,0,0,0],
    attempts:[0,0,0,0]
  };
  const updateScoreBar = ()=>{
    for(let i=0;i<4;i++){
      document.getElementById('s'+(i+1)).textContent = String(Math.round(state.scores[i]));
    }
    const total = state.scores.reduce((a,b)=>a+b,0);
    document.getElementById('totalScore').textContent = String(Math.round(total));
    // Abschluss-Hinweis einblenden, wenn alle Aufgaben abgeschlossen sind
    const allDone = state.attempts.every((att, idx)=>{
      // Eine Aufgabe gilt als abgeschlossen, wenn zwei Versuche gemacht wurden
      // oder wenn die volle Punktzahl erreicht wurde
      const max = [20,20,30,30][idx];
      return att>=2 || Math.round(state.scores[idx]*10)/10 >= max - 1e-9;
    });
    document.getElementById('completeInfo').style.display = allDone ? 'block' : 'none';
    const tip = document.getElementById('reloadTip');
    if(tip) tip.style.display = allDone ? 'block' : 'none';

    // Pill-Färbung
    const thresholds = (pct)=>{
      // 6 Stufen (IHK-ähnlich): <30, <50, <67, <80, <90, >=90
      if(pct < 30) return 'danger';
      if(pct < 50) return 'bad';
      if(pct < 67) return 'mid';
      if(pct < 80) return 'ok';
      if(pct < 90) return 'good';
      return 'excellent';
    };
    const maxPer = [20,20,30,30];
    for(let i=0;i<4;i++){
      const pill = document.getElementById('pill'+(i+1));
      if(!pill) continue;
      pill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
      if(state.attempts[i]===0){
        pill.classList.add('neutral');
      } else {
        const pct = Math.max(0, Math.min(100, (state.scores[i]/maxPer[i])*100));
        pill.classList.add(thresholds(pct));
      }
    }
    const totalPill = document.getElementById('totalPill');
    if(totalPill){
      totalPill.classList.remove('neutral','danger','bad','mid','ok','good','excellent');
      if(!allDone){
        totalPill.classList.add('neutral');
      } else {
        const pct = Math.max(0, Math.min(100, (total/100)*100));
        totalPill.classList.add(thresholds(pct));
      }
    }
  };

  // Aufgabe 1: Wort-Datenbank 200 (ohne Ambiguitäten wie „Laden“)
  const wordsDB = (()=> {
    const o = [];
    NOUNS.forEach(w=>o.push({word:w,pos:'Nomen', expect:'upper', base: stripPunct(w.replace(/^(der|die|das|den|dem|des|ein|eine|einen|einem|einer)\s+/,'')).toLowerCase()}));
    VERBS.forEach(w=>o.push({word:w,pos:'Verb', expect:'lower', base: w.toLowerCase()}));
    PREPS.forEach(w=>o.push({word:w,pos:'Präposition', expect:'lower', base: w.toLowerCase()}));
    ADJS.forEach(w=>o.push({word:w,pos:'Adjektiv', expect:'lower', base: w.toLowerCase()}));
    ARTS.forEach(w=>o.push({word:w,pos:'Artikel', expect:'lower', base: w.toLowerCase()}));
    // Ambiguitäten filtern (Basiform darf nicht in beiden Kategorien vorkommen)
    const seen = {};
    o.forEach(it=>{
      seen[it.base] = seen[it.base] || new Set();
      seen[it.base].add(it.expect);
    });
    const filtered = o.filter(it=> seen[it.base].size === 1);
    return filtered;
  })();

  // Aufgabe 2: Fester Satz-Pool (jeweils 2 Zielwörter pro Satz)

  function buildSentences50(){
  // Fester Pool mit eigenständigen Sätzen, je 2 Zielwörter
    return [
  { tokens:['Am','Montag','hat','Anna','einen','Termin','im','Rathaus.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Im','Juli','fährt','Mehmet','mit','der','Familie','an','den','See.'], targets:[{i:1,should:'upper'},{i:9,should:'upper'}] },
  { tokens:['Heute','arbeitet','sie','im','Büro','und','telefoniert','später.'], targets:[{i:1,should:'lower'},{i:7,should:'lower'}] },
  { tokens:['Lukas','kommt','aus','Hamburg','und','wohnt','jetzt','in','Köln.'], targets:[{i:3,should:'upper'},{i:8,should:'upper'}] },
  { tokens:['Am','Abend','macht','Laura','Hausaufgaben','und','liest','ein','Buch.'], targets:[{i:1,should:'upper'},{i:8,should:'upper'}] },
  { tokens:['Im','Supermarkt','kauft','Ali','Brot','und','Milch.'], targets:[{i:1,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Morgen','fährt','Jana','mit','dem','Bus','zur','Schule.'], targets:[{i:1,should:'lower'},{i:3,should:'lower'}] },
  { tokens:['Wir','treffen','uns','im','Park','und','spielen','Fußball.'], targets:[{i:1,should:'lower'},{i:6,should:'lower'}] },
  { tokens:['Gestern','war','der','Arzt','nicht','da.'], targets:[{i:1,should:'lower'},{i:5,should:'lower'}] },
  { tokens:['Am','Sonntag','besuchen','wir','unsere','Freunde','in','Bonn.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Die','Kinder','spielen','im','Garten','und','lachen','laut.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Paul','geht','nach','der','Arbeit','ins','Fitnessstudio.'], targets:[{i:4,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Im','Café','trinken','wir','Kaffee','und','sprechen','über','die','Schule.'], targets:[{i:1,should:'upper'},{i:9,should:'upper'}] },
  { tokens:['Am','Dienstag','hat','Sara','Deutsch','und','Mathe.'], targets:[{i:1,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Heute','regnet','es','in','Berlin','den','ganzen','Tag.'], targets:[{i:4,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Mein','Bruder','arbeitet','bei','der','Bank','in','Leipzig.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Im','Museum','schaut','Mia','alte','Fotos','und','Bilder','an.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Nach','der','Schule','macht','Omar','Sport','im','Verein.'], targets:[{i:2,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Heute','Abend','kochen','wir','zusammen','Nudeln.'], targets:[{i:2,should:'lower'},{i:3,should:'lower'}] },
  { tokens:['Im','Februar','fährt','Sofia','nach','Österreich','zum','Skifahren.'], targets:[{i:2,should:'lower'},{i:5,should:'upper'}] },
  { tokens:['Der','Bus','kommt','zu','spät','und','die','Leute','warten.'], targets:[{i:2,should:'lower'},{i:5,should:'lower'}] },
  { tokens:['Abends','liest','er','noch','ein','Kapitel','im','Buch.'], targets:[{i:1,should:'lower'},{i:3,should:'lower'}] },
  { tokens:['Im','Kurs','üben','wir','die','Aussprache','und','Grammatik.'], targets:[{i:2,should:'lower'},{i:3,should:'lower'}] },
  { tokens:['Leila','schreibt','eine','E-Mail','an','den','Lehrer.'], targets:[{i:1,should:'lower'},{i:4,should:'lower'}] },
  { tokens:['Am','Markt','kauft','meine','Mutter','frisches','Gemüse.'], targets:[{i:2,should:'lower'},{i:5,should:'lower'}] },
  { tokens:['Wir','gehen','heute','zu','Fuß','in','die','Innenstadt.'], targets:[{i:1,should:'lower'},{i:3,should:'lower'}] },
  { tokens:['Im','April','blühen','die','Bäume','im','Park.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Der','Zug','nach','München','hat','Verspätung.'], targets:[{i:3,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Heute','muss','ich','noch','bei','der','Ärztin','anrufen.'], targets:[{i:4,should:'lower'},{i:6,should:'upper'}] },
  { tokens:['Im','Sommer','fahren','wir','oft','an','die','Nordsee.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Jonas','macht','eine','Pause','und','isst','einen','Apfel.'], targets:[{i:1,should:'lower'},{i:6,should:'lower'}] },
  { tokens:['Nach','dem','Essen','räumt','Tom','die','Küche','auf.'], targets:[{i:2,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Im','Büro','schreibt','die','Chefin','einen','Plan.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Wir','suchen','eine','Wohnung','in','der','Altstadt.'], targets:[{i:1,should:'lower'},{i:6,should:'upper'}] },
  { tokens:['Heute','Abend','sehen','wir','einen','Film','im','Kino.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Bei','Regen','bleiben','die','Kinder','drinnen','und','malen.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Die','Schülerin','fragt','den','Lehrer','nach','den','Hausaufgaben.'], targets:[{i:4,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Am','Freitag','kommt','mein','Bruder','aus','Nürnberg','zu','Besuch.'], targets:[{i:1,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Im','Zoo','sehen','wir','Löwen','und','Elefanten.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Im','Garten','pflanzt','mein','Vater','Tomaten','und','Salat.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Am','Morgen','läuft','sie','zur','Arbeit','und','hört','Musik.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Wir','essen','am','Sonntag','Kuchen','bei','Oma.'], targets:[{i:1,should:'lower'},{i:3,should:'upper'}] },
  { tokens:['In','der','Bibliothek','leiht','sie','ein','Buch','aus.'], targets:[{i:2,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Bitte','stellen','Sie','den','Antrag','bis','morgen.'], targets:[{i:2,should:'upper'},{i:6,should:'lower'}] },
  { tokens:['Am','Donnerstag','geht','die','Klasse','ins','Museum.'], targets:[{i:1,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Wir','fahren','mit','der','U-Bahn','zum','Bahnhof.'], targets:[{i:4,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Nach','dem','Training','trinkt','er','viel','Wasser.'], targets:[{i:2,should:'upper'},{i:6,should:'upper'}] },
  { tokens:['Im','Restaurant','bestellen','wir','eine','Suppe','und','Salat.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Heute','lerne','ich','für','die','Prüfung','und','wiederhole','Grammatik.'], targets:[{i:8,should:'upper'},{i:1,should:'lower'}] },
  { tokens:['Im','Dezember','feiern','wir','Weihnachten','mit','der','Familie.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Am','Morgen','trinkt','Emma','Tee','und','liest','Zeitung.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Heute','kaufe','ich','Brot','und','Käse','im','Laden.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] },
  { tokens:['Im','Herbst','fallen','Blätter','im','Park.'], targets:[{i:1,should:'upper'},{i:3,should:'upper'}] },
  { tokens:['Wir','warten','vor','dem','Kino','und','reden.'], targets:[{i:1,should:'lower'},{i:6,should:'lower'}] },
  { tokens:['Nach','der','Arbeit','fährt','Lea','mit','dem','Fahrrad','nach','Hause.'], targets:[{i:2,should:'upper'},{i:3,should:'lower'}] },
  { tokens:['Im','Theater','spielt','eine','Band','am','Abend.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Mia','schreibt','einen','Brief','und','schickt','ihn','morgen','ab.'], targets:[{i:1,should:'lower'},{i:7,should:'lower'}] },
  { tokens:['Auf','dem','Markt','kostet','das','Brot','zwei','Euro.'], targets:[{i:2,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Im','Bus','sitzt','ein','Kind','neben','mir.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Am','Nachmittag','macht','Tim','Hausaufgaben.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Julia','übt','heute','die','Aussprache','zu','Hause.'], targets:[{i:1,should:'lower'},{i:4,should:'upper'}] },
  { tokens:['Im','Büro','tippt','er','eine','E-Mail.'], targets:[{i:1,should:'upper'},{i:2,should:'lower'}] },
  { tokens:['Der','Lehrer','erklärt','die','Aufgabe','an','der','Tafel.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Sie','putzt','die','Küche','und','wischt','den','Boden.'], targets:[{i:1,should:'lower'},{i:7,should:'upper'}] },
  { tokens:['Im','Winter','trage','ich','eine','Jacke','und','Handschuhe.'], targets:[{i:1,should:'upper'},{i:7,should:'upper'}] },
  { tokens:['Abends','lerne','ich','Vokabeln','und','höre','Musik.'], targets:[{i:1,should:'lower'},{i:6,should:'upper'}] },
  { tokens:['Im','Krankenhaus','besucht','Nina','ihren','Onkel.'], targets:[{i:1,should:'upper'},{i:5,should:'upper'}] },
  { tokens:['Wir','laufen','heute','zu','meinem','Freund.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] },
  { tokens:['Im','Auto','liegt','die','Mappe','auf','dem','Sitz.'], targets:[{i:1,should:'upper'},{i:4,should:'upper'}] },
  { tokens:['Bitte','bringen','Sie','morgen','den','Vertrag','mit.'], targets:[{i:1,should:'lower'},{i:5,should:'upper'}] }
    ];
  }
  const sentencesDB = buildSentences50();

  // Aufgabe 3/4: Fester Pool mit 30 kurzen Texten (A2-Niveau, unterschiedliche Themen)
  function genStories(){
    return [
      { correct: 'Am Samstag besucht Lena ihre Großeltern. Sie helfen ihr bei den Hausaufgaben. Am Abend essen sie zusammen Pizza.' },
      { correct: 'Heute geht Amir zum Arzt. Er hat Kopfschmerzen und wartet im Wartezimmer. Danach holt er ein Rezept aus der Apotheke.' },
      { correct: 'Im Park spielt die Fußballmannschaft von Paul. Seine Schwester bringt Wasser und Obst. Nach dem Spiel fahren alle nach Hause.' },
      { correct: 'Morgens fährt Maria mit der Straßenbahn zur Arbeit. Im Büro schreibt sie E-Mails und telefoniert. In der Pause isst sie ein Brötchen.' },
      { correct: 'Nach der Schule trifft Jonas seine Freunde. Sie lernen für die Prüfung in der Bibliothek. Später gehen sie noch ins Kino.' },
      { correct: 'Im Sommer macht die Familie Urlaub am See. Die Kinder schwimmen und bauen eine Sandburg. Abends grillen sie am Ufer.' },
      { correct: 'Leila kauft auf dem Markt Gemüse und Käse. Der Verkäufer ist freundlich und gibt einen Rabatt. Zu Hause kocht sie Suppe.' },
      { correct: 'Heute Nachmittag putzen wir die Wohnung. Ich wasche das Bad und meine Schwester saugt das Wohnzimmer. Danach trinken wir Kaffee auf dem Balkon.' },
      { correct: 'Tom hat morgen einen Termin im Rathaus. Er bringt seinen Ausweis mit und füllt ein Formular aus. Danach geht er zur Arbeit.' },
      { correct: 'Im Café liest Sara ein Buch. Neben ihr sitzt ein Student und lernt Deutsch. Die Kellnerin bringt Tee und Kuchen.' },
      { correct: 'Omar besucht am Wochenende seine Tante in München. Sie spazieren an der Isar und machen Fotos. Am Sonntag fahren sie zurück.' },
      { correct: 'Im Fitnessstudio trainiert David an den Geräten. Er hört Musik und zählt die Wiederholungen. Nach dem Training trinkt er Wasser.' },
      { correct: 'Im Dezember backen wir Plätzchen. Die Kinder helfen beim Teig und dekorieren die Sterne. Abends riecht die Küche nach Zimt.' },
      { correct: 'Anna lernt für den Deutschkurs. Sie wiederholt die Grammatik und schreibt Sätze. Danach ruht sie sich ein bisschen aus.' },
      { correct: 'Am Morgen läuft Nina zur Haltestelle. Der Bus kommt pünktlich, und sie findet einen Sitzplatz. In der Stadt kauft sie Brot.' },
      { correct: 'Auf dem Spielplatz rutschen die Kinder und lachen. Ein Vater schiebt den Kinderwagen. Die Sonne scheint zwischen den Wolken.' },
      { correct: 'Im Museum sieht Jana alte Bilder und Statuen. Ein Guide erklärt die Geschichte der Stadt. Am Ende kauft sie eine Postkarte.' },
      { correct: 'Bei Regen bleibt die Klasse drinnen. Die Lehrerin liest eine Geschichte vor. Dann malen die Kinder ein Bild.' },
      { correct: 'Im Garten pflanzt Mehmet Tomaten und Salat. Er gießt die Beete jeden Abend. Im Juli erntet er die ersten Früchte.' },
      { correct: 'In der Küche kocht Lara Kartoffeln und Gemüse. Ihr Bruder deckt den Tisch. Danach essen alle zusammen.' },
      { correct: 'Im Zug hört Felix einen Podcast. Er fährt nach Köln, um seinen Freund zu besuchen. Die Fahrt dauert zwei Stunden.' },
      { correct: 'Im Schwimmbad übt Sofia das Rückenschwimmen. Ein Trainer gibt Tipps und zählt die Bahnen. Nach dem Training duscht sie.' },
      { correct: 'Im Büro plant die Chefin ein Meeting. Die Kollegen schreiben die Termine auf. Später schicken sie eine E-Mail.' },
      { correct: 'Auf dem Markt probiert Maya frisches Obst. Der Apfel schmeckt süß und saftig. Sie kauft ein Kilo für zu Hause.' },
      { correct: 'Im Frühling blühen die Bäume im Park. Viele Menschen machen Fotos. Kinder fahren mit dem Roller.' },
      { correct: 'Bei der Bank eröffnet Ali ein Konto. Er unterschreibt die Formulare. Danach bekommt er eine Karte.' },
      { correct: 'Im Restaurant bestellt die Familie Suppe und Salat. Der Kellner bringt das Essen schnell. Zum Schluss zahlen sie bar.' },
      { correct: 'Im Kurs üben wir die Aussprache. Die Lehrerin spricht langsam und deutlich. Dann lesen wir einen Dialog.' },
      { correct: 'Im Urlaub wandern wir in den Bergen. Das Wetter ist sonnig und warm. Abends sitzen wir am Lagerfeuer.' },
      { correct: 'Im Krankenhaus besucht Emma ihre Oma. Eine Schwester bringt Wasser und hilft beim Aufstehen. Emma bleibt eine Stunde.' },
      { correct: 'Im Herbst fallen die Blätter von den Bäumen. Kinder sammeln bunte Blätter. Später basteln sie eine Girlande.' }
    ];
  }
  const storiesDB = genStories();

  // Aufgabe 5 entfernt

  const $ = sel=>document.querySelector(sel);
  const $$ = sel=>Array.from(document.querySelectorAll(sel));

  // Zwei-Versuch-Punkte
  function computeTwoAttemptPoints(totalItems, correctFirst, correctSecondOnly, maxPoints=20){
    const frac = (correctFirst + 0.5*correctSecondOnly) / Math.max(1,totalItems);
    return Math.max(0, Math.min(maxPoints, frac*maxPoints));
  }

  // Aufgabe 1
  let a1 = { items:[], firstCorrect:new Set() };
  function updateTask1CheckEnabled(){
    const remaining = $('#pool1').querySelectorAll('.chip').length;
    // Nach dem ersten Versuch bleibt der Prüfen-Button (1) dauerhaft inaktiv
    const firstAttemptAvailable = state.attempts[0] === 0;
    $('#check1').disabled = !firstAttemptAvailable || remaining>0;
  }
  function initTask1(){
    a1 = { items: pickN(wordsDB,20).map((it,idx)=>({id:'w'+idx, ...it})), firstCorrect:new Set() };
    const pool = $('#pool1'); pool.innerHTML='';
    $('#binUpper').innerHTML=''; $('#binLower').innerHTML='';
    a1.items.forEach(it=>{
      const chip = document.createElement('div');
      chip.className='chip'; chip.draggable=true; chip.id=it.id;
      const base = it.word.replace(/^der |^die |^das |^den |^dem |^des |^ein |^eine |^einen |^einem |^einer /,'');
      chip.textContent = deLower(base);
      chip.dataset.expect = it.expect;
      chip.title = `${it.pos}`;
      chip.addEventListener('dragstart', ev=>{
        ev.dataTransfer.setData('text/plain', it.id);
      });
      pool.appendChild(chip);
    });
    [$('#pool1'), $('#binUpper'), $('#binLower')].forEach(bin=>{
      bin.addEventListener('dragover', ev=>ev.preventDefault());
      bin.addEventListener('drop', ev=>{
        ev.preventDefault();
        const id = ev.dataTransfer.getData('text/plain');
        const el = document.getElementById(id);
        if(!el) return;
        bin.appendChild(el);
        updateTask1CheckEnabled();
      });
    });
    $('#res1').textContent='';
    $('#check1').disabled=true;
    $('#retry1').disabled=true;
  }
  initTask1();

  function checkTask1(isRetry=false){
    const total = a1.items.length;
    let newlyCorrect = 0;
    const pool = $('#pool1');

    a1.items.forEach(it=>{
      const el = document.getElementById(it.id);
      if(!el) return;
      const parent = el.parentElement;
      const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
      const ok = (placedZone === it.expect);
      if(!isRetry){
        if(ok) a1.firstCorrect.add(it.id);
      }else{
        if(ok && !a1.firstCorrect.has(it.id)) newlyCorrect++;
      }
      // richtige sperren, falsche zurück in den Ausgangskasten
      if(ok){
        el.style.boxShadow = 'inset 0 0 0 2px #a5d6a7';
        el.classList.add('locked'); el.draggable=false;
      }else{
        el.style.boxShadow = '';
        pool.appendChild(el);
      }
    });

    let points;
    if(!isRetry){
      points = computeTwoAttemptPoints(total, a1.firstCorrect.size, 0, 20);
      $('#res1').innerHTML = `Richtig im 1. Versuch: ${a1.firstCorrect.size}/${total} → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=false;
      hardDisableButton('#check1');
    }else{
  points = computeTwoAttemptPoints(total, a1.firstCorrect.size, newlyCorrect, 20);
      $('#res1').innerHTML = `Nach 2. Versuch: +${(newlyCorrect*0.5*20/total).toFixed(1)} Punkte → <span class="ok">${points.toFixed(1)} Punkte</span>`;
      $('#check1').disabled=true; $('#retry1').disabled=true;
      hardDisableButton('#check1');
      hardDisableButton('#retry1');
      // Nach dem 2. Versuch: alle noch falschen Wörter automatisch korrekt zuordnen und rot markieren
      a1.items.forEach(it=>{
        const el = document.getElementById(it.id);
        if(!el) return;
        const parent = el.parentElement;
        const placedZone = (parent && parent.classList.contains('bin')) ? parent.dataset.accept : null;
        const ok = (placedZone === it.expect);
        if(!ok){
          const targetBin = it.expect === 'upper' ? $('#binUpper') : $('#binLower');
          targetBin.appendChild(el);
          el.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
          el.style.background = '#fff7f7';
        } else {
          el.style.boxShadow = 'inset 0 0 0 2px #a5d6a7';
        }
        el.classList.add('locked');
        el.draggable = false;
      });
    }
    state.scores[0] = points;
    state.attempts[0] = isRetry ? 2 : 1;
    updateScoreBar();
    updateTask1CheckEnabled();
  }

  $('#check1').addEventListener('click', ()=>checkTask1(false));
  $('#retry1').addEventListener('click', ()=>checkTask1(true));
  // Entfernt: Neuerstellen per Button (nur per Seiten-Reload)

  // Aufgabe 2
  let a2 = { data:[], firstCorrect:new Set() };
  function updateTask2CheckEnabled(){
    const all = Array.from(document.querySelectorAll('#sentences .smallcaps'));
    const decided = all.filter(sp=> (sp.dataset.choice||'') !== '');
    // Nach dem ersten Versuch bleibt der Prüfen-Button (1) dauerhaft inaktiv
    const firstAttemptAvailable = state.attempts[1] === 0;
    $('#check2').disabled = !firstAttemptAvailable || decided.length !== all.length || all.length===0;
  }
  function renderTask2(){
    a2 = { data: pickN(sentencesDB, 10), firstCorrect:new Set() };
    const container = $('#sentences'); container.innerHTML='';
    a2.data.forEach((s, si)=>{
      const card = document.createElement('div'); card.className='card sentence'; card.dataset.si = si;
      const line = document.createElement('div');
      s.tokens.forEach((tok, i)=>{
        const tinfo = s.targets.find(t=>t.i===i);
        if(tinfo){
          // Zielwort ohne angehängte Zeichensetzung in Span, Satzzeichen separat anhängen
          const m = /^(.+?)([.,;:!?]+)?$/.exec(tok) || [];
          const base = m[1] || tok;
          const punc = m[2] || '';
          const sp = document.createElement('span');
          sp.className='smallcaps pending';
          sp.textContent = deLower(base);
          sp.dataset.si = si;
          sp.dataset.ti = i;
          sp.dataset.correct = tinfo.should; // 'upper'|'lower'
          sp.dataset.choice = '';
          sp.addEventListener('click', onPopup);
          line.appendChild(sp);
          if(punc) line.append(punc);
        }else{
          line.append(tok);
        }
        if(i < s.tokens.length-1) line.append(' ');
      });
      card.appendChild(line);
      container.appendChild(card);
    });
    $('#res2').textContent='';
    $('#check2').disabled=true; $('#retry2').disabled=true;
    updateTask2CheckEnabled();
  }
  renderTask2();

  const popup = $('#popup2');
  function onPopup(ev){
    const target = ev.currentTarget;
    const rect = target.getBoundingClientRect();
    popup.style.left = Math.max(8, rect.left + window.scrollX) + 'px';
    popup.style.top = (rect.top + window.scrollY - 42) + 'px';
    popup.style.display='block';
    popup.dataset.targetSi = target.dataset.si;
    popup.dataset.targetTi = target.dataset.ti;
  }
  document.addEventListener('click', (e)=>{
    if(!popup.contains(e.target) && !e.target.classList.contains('smallcaps')){
      popup.style.display='none';
    }
  });
  popup.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const si = Number(popup.dataset.targetSi);
      const ti = Number(popup.dataset.targetTi);
      const choice = btn.dataset.choice; // 'upper'|'lower'
      const span = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${ti}"]`);
      if(span){
        span.dataset.choice = choice;
        // Schreibweise direkt im Text ändern: fett + groß/klein
        const current = span.textContent;
        const wordLower = deLower(current);
        span.style.fontWeight = '700';
        if(choice==='upper'){
          span.textContent = capFirst(wordLower);
        }else{
          span.textContent = wordLower;
        }
        span.classList.remove('pending');
      }
      popup.style.display='none';
      updateTask2CheckEnabled();
    });
  });

  function checkTask2(isRetry=false){
    let totalTargets=0, newly=0;
    const wrongSentences = new Set();
    // prüfen satzweise
    a2.data.forEach((s, si)=>{
      let sentenceOK = true;
      s.targets.forEach(t=>{
        totalTargets++;
        const span = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
        const choice = span?.dataset.choice || '';
        const ok = (choice === t.should);
        if(!ok) sentenceOK = false;
        if(!isRetry){
          if(ok){ a2.firstCorrect.add(`${si}-${t.i}`); }
        }else{
          if(ok && !a2.firstCorrect.has(`${si}-${t.i}`)) newly++;
        }
      });
      const card = $(`#task2 .sentence[data-si="${si}"]`);
      card.classList.toggle('error', !sentenceOK);
      if(!sentenceOK) wrongSentences.add(si);
    });
  const pts = computeTwoAttemptPoints(totalTargets, a2.firstCorrect.size, newly, 20);
    if(!isRetry){
      $('#res2').innerHTML = `Sätze mit Fehlern: ${wrongSentences.size} von ${a2.data.length} → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      // In allen falschen Sätzen die Zielwörter ins Ursprungsformat (smallcaps, klein, orange) zurücksetzen
      wrongSentences.forEach(si=>{
        const spans = $$(`#task2 .smallcaps[data-si="${si}"]`);
        spans.forEach(sp=>{
          sp.dataset.choice = '';
          sp.style.fontWeight = '400';
          const wordLower = deLower(sp.textContent);
          sp.textContent = wordLower;
          sp.classList.add('pending');
        });
      });
      $('#check2').disabled=true; $('#retry2').disabled=false;
      hardDisableButton('#check2');
    }else{
      $('#res2').innerHTML = `Nach 2. Versuch: korrigiert +${(newly*0.5*20/totalTargets).toFixed(1)} Punkte → <span class="ok">${pts.toFixed(1)} Punkte</span>`;
      $('#check2').disabled=true; $('#retry2').disabled=true;
      hardDisableButton('#check2');
      hardDisableButton('#retry2');
      // Nach dem 2. Versuch: falsche Zielwörter automatisch korrigieren und rot markieren
      a2.data.forEach((s, si)=>{
        s.targets.forEach(t=>{
          const sp = $(`#task2 .smallcaps[data-si="${si}"][data-ti="${t.i}"]`);
          const ok = (sp?.dataset.choice === t.should);
          if(!ok && sp){
            const base = deLower(sp.textContent);
            if(t.should==='upper'){
              sp.textContent = capFirst(base);
            }else{
              sp.textContent = base;
            }
            sp.style.fontWeight = '700';
            sp.classList.remove('pending');
            sp.style.background = '#fff7f7';
            sp.style.borderBottomColor = '#ef9a9a';
            sp.style.color = '#c62828';
          }
        });
      });
    }
    state.scores[1] = pts; state.attempts[1] = isRetry?2:1; updateScoreBar();
  }
  $('#check2').addEventListener('click', ()=>checkTask2(false));
  $('#retry2').addEventListener('click', ()=>checkTask2(true));
  // Entfernt: Neue Sätze per Button (nur per Seiten-Reload)

  // Aufgabe 3
  function storyToTokens(correctText){
    const raw = tokenize(correctText);
    return raw.map(tok=>{
      if(isWord(tok)){
        const should = /^[A-ZÄÖÜ]/.test(tok);
        return {text: tok, isWord:true, shouldCap: should};
      }else{
        return {text: tok, isWord:false, shouldCap:false};
      }
    });
  }

  let a3 = { idx:0, tokens:[], userCap:[], firstCorrect:[], clicked:[], firstUserCap:[], scoreUnitsFirst:0, maxUnits:0 };
  function initTask3(){
    const idx = rnd(storiesDB.length);
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
  a3 = { idx, tokens: toks, userCap: toks.map(t=>false), firstCorrect: toks.map(()=>false), clicked: toks.map(()=>false), firstUserCap: toks.map(()=>false), scoreUnitsFirst:0, maxUnits: toks.filter(t=>t.isWord && t.shouldCap).length };
    const host = $('#story3'); host.innerHTML='';
    toks.forEach((t, i)=>{
      const span = document.createElement('span');
      span.className = 'tok';
      span.dataset.i = i;
      if(t.isWord){
        span.textContent = deLower(t.text);
        span.addEventListener('click', ()=>{
          if(span.classList.contains('locked')) return;
          a3.userCap[i] = !a3.userCap[i];
          a3.clicked[i] = true;
          span.classList.toggle('cap', a3.userCap[i]);
          const base = deLower(t.text);
          span.textContent = a3.userCap[i] ? capFirst(base) : base;
        });
      }else{
        span.textContent = t.text;
        span.classList.add('locked');
      }
      host.appendChild(span);
      if(t.isWord) host.append(' ');
    });
    $('#res3').textContent='';
    $('#check3').disabled=false; $('#retry3').disabled=true;
  }
  initTask3();

  function checkTask3(isRetry=false){
    const words = a3.tokens.map((t,i)=>({t,i})).filter(x=>x.t.isWord);
    const mustCap = words.filter(x=>x.t.shouldCap).map(x=>x.i);
    const mustLower = words.filter(x=>!x.t.shouldCap).map(x=>x.i);
    let scoreUnits = 0; // Zählpunkte: +1 korrekt groß (nur mustCap), -1 fälschlich groß (mustLower)
    let newlyFixedMustCap = 0;
    words.forEach(({t,i})=>{
      const isCap = !!a3.userCap[i];
      if(t.shouldCap && isCap) scoreUnits += 1;
      if(!t.shouldCap && isCap) scoreUnits -= 1;
      if(isRetry){
        // Zähle neu korrekt groß gesetzte Muss-Groß-Wörter
        if(t.shouldCap && isCap && !a3.firstUserCap[i]) newlyFixedMustCap++;
      } else {
        a3.firstCorrect[i] = (isCap === t.shouldCap);
        a3.firstUserCap[i] = isCap;
      }
      const span = $(`#story3 .tok[data-i="${i}"]`);
      span.classList.remove('correct');
      if(!isRetry){
        if(t.shouldCap && isCap && a3.clicked[i]){ span.classList.add('correct'); span.classList.add('locked'); }
        else {
          const base = deLower(t.text);
          a3.userCap[i] = false; // zurücksetzen
          span.textContent = base;
          span.classList.remove('cap');
        }
      }
    });
    // Skaliere auf 30 Punkte: max +MustCap, min 0 (negative nicht unter 0)
    const maxUnits = mustCap.length;
    let scoreUnitsFinal;
    if(!isRetry){
      a3.scoreUnitsFirst = scoreUnits; // speichern fürs 2. Mal
      scoreUnitsFinal = scoreUnits;
    } else {
      scoreUnitsFinal = a3.scoreUnitsFirst + 0.5 * newlyFixedMustCap;
    }
    // Anteil bezogen auf Muss-Groß-Wörter; nicht negativ, nicht größer als maxUnits
    const norm = Math.max(0, Math.min(maxUnits, scoreUnitsFinal));
    const pts = Math.round((norm / Math.max(1, maxUnits)) * 30);
    if(!isRetry){
  const additionally = Math.max(0, mustCap.length - mustCap.filter(i=>a3.userCap[i]).length);
  $('#res3').innerHTML = `Bewertung im 1. Versuch: ${norm}/${maxUnits} → <span class="ok">${pts} Punkte</span> <span class="warn">(zusätzlich groß zu schreiben: ${additionally})</span>`;
      $('#check3').disabled=true; $('#retry3').disabled=false;
    }else{
      // Nach 2. Versuch: korrigiere Text und markiere alle weiterhin falschen Wörter rot
      words.forEach(({t,i})=>{
        const span = $(`#story3 .tok[data-i="${i}"]`);
        const should = t.shouldCap;
        const base = deLower(t.text);
        const isCap = !!a3.userCap[i];
        // Setze Text korrekt
        span.textContent = should ? capFirst(base) : base;
        span.classList.remove('correct','cap');
        span.classList.add('locked');
        if(isCap !== should){
          // falsch im 2. Versuch → rot markieren
          span.style.background = '#fff7f7';
          span.style.boxShadow = 'inset 0 0 0 2px #ef9a9a';
        }
      });
  $('#res3').innerHTML = `Nach 2. Versuch: aktualisiert → <span class="ok">${pts} Punkte</span>`;
      $('#check3').disabled=true; $('#retry3').disabled=true;
      hardDisableButton('#check3');
      hardDisableButton('#retry3');
    }
    state.scores[2] = pts; state.attempts[2] = isRetry?2:1; updateScoreBar();
  }
  $('#check3').addEventListener('click', ()=>checkTask3(false));
  $('#retry3').addEventListener('click', ()=>checkTask3(true));
  // Entfernt: Andere Geschichte per Button (nur per Seiten-Reload)

  // Aufgabe 4
  let a4 = { idx:0, tokens:[], lowerSrc:'' };
  function initTask4(){
    // pick another story different from a3.idx
    const options = storiesDB.map((_,i)=>i).filter(i=>i!==a3.idx);
    const idx = options[rnd(options.length)];
    const story = storiesDB[idx].correct;
    const toks = storyToTokens(story);
    a4 = { idx, tokens: toks, lowerSrc: story.toLocaleLowerCase('de-DE') }; // mit Leerzeichen
    $('#story4src').textContent = a4.lowerSrc;
    $('#story4txt').value = '';
    $('#story4feedback').innerHTML='';
    $('#res4').textContent='';
    $('#check4').disabled=true; $('#retry4').disabled=true;
    $('#c4').textContent='';
  }
  initTask4();
  // Kopieren/Markieren des Ursprungstextes unterbinden
  ['copy','cut','contextmenu','selectstart','dragstart'].forEach(evt=>{
    document.getElementById('story4src').addEventListener(evt, e=>{
      e.preventDefault();
      return false;
    });
  });

  function analyzeUserVsStory(userText, storyTokens){
    const userTokens = storyToTokens(userText); // alle Tokens inkl. Satzzeichen
    const storyWords = storyTokens.filter(t=>t.isWord);
    const total = storyWords.length;
    const result = [];
    let correctFirst=0, typos=0;

    let wi = 0; // Wortindex in der Vorlage
    for(const tok of userTokens){
      if(tok.isWord){
        let capOK=false, spellOK=false;
        if(wi < storyWords.length){
          const exp = storyWords[wi];
          const expShouldCap = exp.shouldCap;
          const gotIsCap = /^[A-ZÄÖÜ]/.test(tok.text);
          const baseExp = deLower(exp.text);
          const baseGot = deLower(tok.text);
          capOK = (expShouldCap === gotIsCap);
          spellOK = (baseExp === baseGot);
          if(capOK) correctFirst++;
          if(!spellOK) typos++;
        }
        result.push({type:'word', text: tok.text, capOK, spellOK});
        wi++;
      } else if(/[.,;:!?]/.test(tok.text)){
        result.push({type:'punct', text: tok.text});
      } else {
        // sonstige Tokens (Spaces etc.) ignorieren
      }
    }
    // Fehlende Wörter aus der Vorlage einfügen
    const missing = Math.max(0, storyWords.length - wi);
    if(missing>0){
      for(let k=wi; k<storyWords.length; k++){
        result.push({type:'missing', expected: deLower(storyWords[k].text)});
      }
    }
  const pts = (correctFirst/Math.max(1,total))*30;
  return { items: result, total, correctCount: correctFirst, typos, missing, points: Math.round(Math.max(0, Math.min(30, pts))) };
  }

  let a4first = null;
  function checkTask4(isRetry=false){
    const text = $('#story4txt').value;
    const analysis = analyzeUserVsStory(text, a4.tokens);
    if(!isRetry){
      a4first = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      // Nach dem ersten Versuch: nur Schreibfehler zeigen (keine Groß-/Kleinschreibung)
      $('#story4feedback').innerHTML = renderFeedback(analysis.items, false);
      // Hilfetext: Zähle Richtungsfehler (falsch groß vs. falsch klein)
      const wordItems = analysis.items.filter(x=>x.type==='word');
      let wrongAsUpper=0, wrongAsLower=0;
      for(let i=0;i<wordItems.length;i++){
        const shouldCap = a4.tokens.filter(t=>t.isWord)[i]?.shouldCap;
        const gotIsCap = /^[A-ZÄÖÜ]/.test(wordItems[i].text);
        if(shouldCap && !gotIsCap) wrongAsLower++;
        if(!shouldCap && gotIsCap) wrongAsUpper++;
      }
  $('#res4').innerHTML = `Richtig (Groß/Klein) im 1. Versuch: ${analysis.correctCount}/${analysis.total} → <span class="ok">${Math.round(analysis.points)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span><br/><span class="hint">Wörter, die du groß geschrieben hast, die du aber klein schreiben musst: ${wrongAsUpper}<br/>Wörter, die du klein geschrieben hast, die du aber groß schreiben musst: ${wrongAsLower}</span>`;
      state.scores[3] = analysis.points;
      $('#check4').disabled=true; $('#retry4').disabled=false;
      state.attempts[3] = 1;
      // Ersten Prüfen-Button hart deaktivieren, damit er nicht erneut aktiv wird
      hardDisableButton('#check4');
    }else{
      const now = analysis.items.filter(x=>x.type==='word').map(x=>x.capOK);
      let newly=0;
      for(let i=0;i<now.length;i++){
        if(now[i] && a4first && !a4first[i]) newly++;
      }
  const pts = computeTwoAttemptPoints(analysis.total, (a4first||[]).filter(Boolean).length, newly, 30);
    // Im zweiten Versuch: alle Fehler inkl. Groß-/Kleinschreibung anzeigen
    $('#story4feedback').innerHTML = renderFeedback(analysis.items, true);
  $('#res4').innerHTML = `Nach 2. Versuch: +${Math.round(newly*0.5*30/analysis.total)} Punkte → <span class="ok">${Math.round(pts)} Punkte</span> <span class="warn">(Schreibfehler: ${analysis.typos}, fehlende Wörter: ${analysis.missing})</span>`;
  hardDisableButton('#check4');
  hardDisableButton('#retry4');
      state.scores[3] = pts;
      $('#check4').disabled=true; $('#retry4').disabled=true;
      state.attempts[3] = 2;
    }
    updateScoreBar();
  }
  function renderFeedback(items, showCap=true){
    const style = 'padding:2px 4px; border-radius:6px; margin-right:4px; display:inline-block';
    const out = [];
    for(const x of items){
      if(x.type==='punct'){
        // Satzzeichen direkt anhängen (ohne zusätzliches Leerzeichen davor)
        const last = out.length ? out.pop() : '';
        const merged = (last || '') + `${x.text}`;
        out.push(merged);
        continue;
      }
      if(x.type==='missing'){
        out.push(`<span class="mark-typo" style="${style}">[${x.expected}]</span>`);
        continue;
      }
      // Wörter
      let cls = x.capOK ? 'correct' : 'mark-cap';
      if(!showCap){
        // Groß-/Kleinschreibung im 1. Versuch ausblenden; nur Schreibfehler zeigen
        cls = x.spellOK ? '' : 'mark-typo';
      } else {
        if(!x.spellOK) cls = 'mark-typo';
      }
      const token = cls ? `<span class="${cls}" style="${style}">${x.text}</span>` : `${x.text}`;
      out.push(token);
    }
    // Wörter mit Leerzeichen verbinden; Satzzeichen sind bereits ohne Extraleerzeichen angefügt
    return out.join(' ');
  }
  $('#check4').addEventListener('click', ()=>checkTask4(false));
  $('#retry4').addEventListener('click', ()=>checkTask4(true));
  // Entfernt: Andere Geschichte per Button (nur per Seiten-Reload)
  $('#story4txt').addEventListener('input', ()=>{
    const v = $('#story4txt').value;
    const w = v.trim().split(/\s+/).filter(Boolean).length;
    $('#c4').textContent = `Wörter: ${w}`;
    // Prüfen erst möglich, wenn etwas geschrieben wurde und mind. ein Leerzeichen vorhanden ist
    if(state.attempts[3] === 0){
      $('#check4').disabled = !(v.trim().length>0 && /\s/.test(v));
    } else {
      $('#check4').disabled = true;
    }
  });

  // Aufgabe 5 vollständig entfernt (Freitext-Teil)

  // (Entfernt doppelte Listener für Aufgabe 2 und 3)

  // Init Punkte
  updateScoreBar();

})();
</script>
</body>
</html>